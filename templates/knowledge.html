{% extends "base.html" %}

{% block title %}çŸ¥è¯†åº“ç®¡ç† - Difyæ™ºèƒ½åŠ©æ‰‹{% endblock %}

{% block page_title %}ğŸ—„ï¸ çŸ¥è¯†åº“ç®¡ç†{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- çŸ¥è¯†åº“åˆ—è¡¨ -->
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-database me-2"></i>çŸ¥è¯†åº“åˆ—è¡¨
                        </h6>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createDatasetModal">
                            <i class="fas fa-plus me-1"></i>æ–°å»º
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="datasets-list" class="list-group list-group-flush">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <div class="mt-2 text-muted">åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- çŸ¥è¯†åº“è¯¦æƒ… -->
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0" id="dataset-title">
                            <i class="fas fa-folder-open me-2"></i>é€‰æ‹©ä¸€ä¸ªçŸ¥è¯†åº“
                        </h6>
                        <div class="btn-group btn-group-sm" id="dataset-actions" style="display: none;">
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addDocumentModal">
                                <i class="fas fa-file-plus me-1"></i>æ·»åŠ æ–‡æ¡£
                            </button>
                            <button class="btn btn-outline-info" onclick="testRetrieval()">
                                <i class="fas fa-search me-1"></i>æ£€ç´¢æµ‹è¯•
                            </button>
                            <button class="btn btn-outline-danger" onclick="confirmDeleteDataset()">
                                <i class="fas fa-trash me-1"></i>åˆ é™¤çŸ¥è¯†åº“
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- çŸ¥è¯†åº“ä¿¡æ¯ -->
                    <div id="dataset-info" style="display: none;">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-info-circle text-primary me-2"></i>
                                    <strong>åŸºæœ¬ä¿¡æ¯</strong>
                                </div>
                                <div class="ps-3">
                                    <div class="mb-1"><strong>åç§°:</strong> <span id="dataset-name">-</span></div>
                                    <div class="mb-1"><strong>æè¿°:</strong> <span id="dataset-description">-</span></div>
                                    <div class="mb-1"><strong>åˆ›å»ºæ—¶é—´:</strong> <span id="dataset-created">-</span></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-chart-bar text-success me-2"></i>
                                    <strong>ç»Ÿè®¡ä¿¡æ¯</strong>
                                </div>
                                <div class="ps-3">
                                    <div class="mb-1"><strong>æ–‡æ¡£æ•°é‡:</strong> <span id="dataset-doc-count">0</span></div>
                                    <div class="mb-1"><strong>å­—ç¬¦æ•°:</strong> <span id="dataset-word-count">0</span></div>
                                    <div class="mb-1"><strong>åº”ç”¨æ•°:</strong> <span id="dataset-app-count">0</span></div>
                                </div>
                            </div>
                        </div>
                        <hr>
                    </div>

                    <!-- é»˜è®¤æç¤º -->
                    <div id="no-dataset-selected" class="text-center py-5 text-muted">
                        <i class="fas fa-database fa-3x mb-3"></i>
                        <h5>è¯·é€‰æ‹©ä¸€ä¸ªçŸ¥è¯†åº“</h5>
                        <p>é€‰æ‹©å·¦ä¾§çš„çŸ¥è¯†åº“æ¥æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯å’Œç®¡ç†æ–‡æ¡£</p>
                    </div>

                    <!-- æ–‡æ¡£åˆ—è¡¨ -->
                    <div id="documents-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">
                                <i class="fas fa-file-alt me-2"></i>æ–‡æ¡£åˆ—è¡¨
                            </h6>
                            <button class="btn btn-outline-secondary btn-sm" onclick="refreshDocuments()">
                                <i class="fas fa-sync-alt me-1"></i>åˆ·æ–°
                            </button>
                        </div>
                        
                        <div id="documents-list">
                            <!-- æ–‡æ¡£åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»ºçŸ¥è¯†åº“æ¨¡æ€æ¡† -->
<div class="modal fade" id="createDatasetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>åˆ›å»ºçŸ¥è¯†åº“
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-dataset-form">
                    <div class="mb-3">
                        <label for="dataset-name-input" class="form-label">çŸ¥è¯†åº“åç§° *</label>
                        <input type="text" class="form-control" id="dataset-name-input" 
                               placeholder="è¯·è¾“å…¥çŸ¥è¯†åº“åç§°" required>
                    </div>
                    <div class="mb-3">
                        <label for="dataset-description-input" class="form-label">æè¿°</label>
                        <textarea class="form-control" id="dataset-description-input" 
                                  rows="3" placeholder="è¯·è¾“å…¥çŸ¥è¯†åº“æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="createDataset()">åˆ›å»º</button>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ æ–‡æ¡£æ¨¡æ€æ¡† -->
<div class="modal fade" id="addDocumentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-plus me-2"></i>æ·»åŠ æ–‡æ¡£
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- æ–‡æ¡£ç±»å‹é€‰æ‹© -->
                <div class="mb-3">
                    <label class="form-label">æ·»åŠ æ–¹å¼</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="document-type" id="text-type" value="text" checked>
                        <label class="btn btn-outline-primary" for="text-type">
                            <i class="fas fa-edit me-1"></i>æ–‡æœ¬è¾“å…¥
                        </label>
                        
                        <input type="radio" class="btn-check" name="document-type" id="file-type" value="file">
                        <label class="btn btn-outline-primary" for="file-type">
                            <i class="fas fa-upload me-1"></i>æ–‡ä»¶ä¸Šä¼ 
                        </label>
                    </div>
                </div>

                <!-- æ–‡æœ¬è¾“å…¥æ–¹å¼ -->
                <div id="text-input-section">
                    <form id="add-document-text-form">
                        <div class="mb-3">
                            <label for="document-name-input" class="form-label">æ–‡æ¡£åç§° *</label>
                            <input type="text" class="form-control" id="document-name-input" 
                                   placeholder="è¯·è¾“å…¥æ–‡æ¡£åç§°" required>
                        </div>
                        <div class="mb-3">
                            <label for="document-content-input" class="form-label">æ–‡æ¡£å†…å®¹ *</label>
                            <textarea class="form-control" id="document-content-input" 
                                      rows="12" placeholder="è¯·è¾“å…¥æ–‡æ¡£å†…å®¹" required></textarea>
                            <div class="form-text">
                                <span id="document-char-count">0</span> å­—ç¬¦
                            </div>
                        </div>
                    </form>
                </div>

                <!-- æ–‡ä»¶ä¸Šä¼ æ–¹å¼ -->
                <div id="file-upload-section" style="display: none;">
                    <form id="add-document-file-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="document-file-input" class="form-label">é€‰æ‹©æ–‡ä»¶ *</label>
                            <input type="file" class="form-control" id="document-file-input" 
                                   accept=".txt,.pdf,.doc,.docx,.xls,.xlsx,.csv,.md,.html"
                                   onchange="handleFileSelect(this)">
                            <div class="form-text">
                                æ”¯æŒæ ¼å¼ï¼šTXT, PDF, DOC, DOCX, XLS, XLSX, CSV, MD, HTMLï¼ˆæœ€å¤§50MBï¼‰
                            </div>
                        </div>
                        <div id="file-preview" style="display: none;" class="mb-3">
                            <div class="alert alert-info">
                                <i class="fas fa-file me-2"></i>
                                <span id="file-name"></span>
                                <span class="text-muted">ï¼ˆ<span id="file-size"></span>ï¼‰</span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="addDocument()">
                    <i class="fas fa-plus me-1"></i>æ·»åŠ æ–‡æ¡£
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ£€ç´¢æµ‹è¯•æ¨¡æ€æ¡† -->
<div class="modal fade" id="retrievalTestModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>çŸ¥è¯†æ£€ç´¢æµ‹è¯•
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="query-input" class="form-label">æŸ¥è¯¢é—®é¢˜</label>
                    <input type="text" class="form-control" id="query-input" 
                           placeholder="è¯·è¾“å…¥è¦æ£€ç´¢çš„é—®é¢˜">
                </div>
                <div class="mb-3">
                    <button class="btn btn-primary" onclick="performRetrieval()">
                        <i class="fas fa-search me-1"></i>å¼€å§‹æ£€ç´¢
                    </button>
                </div>
                <div id="retrieval-results" style="display: none;">
                    <h6>æ£€ç´¢ç»“æœ:</h6>
                    <div id="retrieval-content" class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                        <!-- æ£€ç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    var currentDatasetId = null;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadDatasets();
        
        // ç»‘å®šå­—ç¬¦è®¡æ•°
        document.getElementById('document-content-input').addEventListener('input', function() {
            document.getElementById('document-char-count').textContent = this.value.length;
        });

        // ç»‘å®šæ–‡æ¡£ç±»å‹åˆ‡æ¢
        document.querySelectorAll('input[name="document-type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                toggleDocumentInputType(this.value);
            });
        });
    });

    // åˆ‡æ¢æ–‡æ¡£è¾“å…¥ç±»å‹
    function toggleDocumentInputType(type) {
        const textSection = document.getElementById('text-input-section');
        const fileSection = document.getElementById('file-upload-section');
        
        if (type === 'text') {
            textSection.style.display = 'block';
            fileSection.style.display = 'none';
        } else {
            textSection.style.display = 'none';
            fileSection.style.display = 'block';
        }
    }

    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelect(input) {
        const file = input.files[0];
        if (!file) {
            document.getElementById('file-preview').style.display = 'none';
            return;
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-size').textContent = formatFileSize(file.size);
        document.getElementById('file-preview').style.display = 'block';
    }

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨
    async function loadDatasets() {
        try {
            const response = await fetch('/api/datasets');
            const data = await response.json();
            
            const container = document.getElementById('datasets-list');
            
            if (data.data && data.data.length > 0) {
                container.innerHTML = data.data.map(dataset => `
                    <div class="list-group-item list-group-item-action dataset-item" 
                         onclick="selectDataset('${dataset.id}', '${dataset.name}')" 
                         data-id="${dataset.id}">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${dataset.name}</h6>
                            <small class="text-muted">${formatTime(dataset.created_at)}</small>
                        </div>
                        <p class="mb-1 text-muted">${dataset.description || 'æš‚æ— æè¿°'}</p>
                        <small class="text-info">
                            <i class="fas fa-file-alt me-1"></i>${dataset.document_count} æ–‡æ¡£
                            <i class="fas fa-font ms-2 me-1"></i>${dataset.word_count} å­—ç¬¦
                        </small>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-database fa-2x mb-2"></i>
                        <div>æš‚æ— çŸ¥è¯†åº“</div>
                        <small>ç‚¹å‡»"æ–°å»º"åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªçŸ¥è¯†åº“</small>
                    </div>
                `;
            }
        } catch (error) {
            console.error('åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨å¤±è´¥:', error);
            showToast('åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨å¤±è´¥', 'error');
        }
    }

    // é€‰æ‹©çŸ¥è¯†åº“
    function selectDataset(datasetId, datasetName) {
        currentDatasetId = datasetId;
        
        // æ›´æ–°æ´»è·ƒçŠ¶æ€
        document.querySelectorAll('.dataset-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-id="${datasetId}"]`).classList.add('active');
        
        // æ˜¾ç¤ºçŸ¥è¯†åº“ä¿¡æ¯
        document.getElementById('no-dataset-selected').style.display = 'none';
        document.getElementById('dataset-info').style.display = 'block';
        document.getElementById('documents-section').style.display = 'block';
        document.getElementById('dataset-actions').style.display = 'block';
        
        // æ›´æ–°æ ‡é¢˜
        document.getElementById('dataset-title').innerHTML = `
            <i class="fas fa-folder-open me-2"></i>${datasetName}
        `;
        
        // åŠ è½½çŸ¥è¯†åº“è¯¦ç»†ä¿¡æ¯
        loadDatasetDetails(datasetId);
    }

    // åŠ è½½çŸ¥è¯†åº“è¯¦ç»†ä¿¡æ¯
    async function loadDatasetDetails(datasetId) {
        try {
            // è¿™é‡Œå¯ä»¥æ·»åŠ è·å–çŸ¥è¯†åº“è¯¦ç»†ä¿¡æ¯çš„APIè°ƒç”¨
            // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            document.getElementById('dataset-name').textContent = 'å½“å‰çŸ¥è¯†åº“';
            document.getElementById('dataset-description').textContent = 'æš‚æ— æè¿°';
            document.getElementById('dataset-created').textContent = new Date().toLocaleString('zh-CN');
            document.getElementById('dataset-doc-count').textContent = '0';
            document.getElementById('dataset-word-count').textContent = '0';
            document.getElementById('dataset-app-count').textContent = '0';
            
            // åŠ è½½æ–‡æ¡£åˆ—è¡¨
            loadDocuments(datasetId);
        } catch (error) {
            console.error('åŠ è½½çŸ¥è¯†åº“è¯¦æƒ…å¤±è´¥:', error);
        }
    }

    // åŠ è½½æ–‡æ¡£åˆ—è¡¨
    async function loadDocuments(datasetId) {
        try {
            const response = await fetch(`/api/datasets/${datasetId}/documents`);
            const data = await response.json();
            
            const container = document.getElementById('documents-list');
            
            if (data.data && data.data.length > 0) {
                container.innerHTML = data.data.map(doc => `
                    <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${doc.name}</h6>
                                <span class="badge bg-${getStatusColor(doc.indexing_status)} rounded-pill">
                                    ${getStatusText(doc.indexing_status)}
                                </span>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>${formatTime(doc.created_at)}
                                <i class="fas fa-font ms-2 me-1"></i>${doc.word_count || 0} å­—ç¬¦
                                <i class="fas fa-coins ms-2 me-1"></i>${doc.tokens || 0} tokens
                            </small>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                    data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="viewDocument('${doc.id}', '${doc.name}')">
                                    <i class="fas fa-eye me-1"></i>æŸ¥çœ‹è¯¦æƒ…
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="confirmDeleteDocument('${doc.id}', '${doc.name}')">
                                    <i class="fas fa-trash me-1"></i>åˆ é™¤
                                </a></li>
                            </ul>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-file-alt fa-2x mb-2"></i>
                        <div>æš‚æ— æ–‡æ¡£</div>
                        <small>ç‚¹å‡»"æ·»åŠ æ–‡æ¡£"å¼€å§‹æ„å»ºçŸ¥è¯†åº“</small>
                    </div>
                `;
            }
        } catch (error) {
            console.error('åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥:', error);
            showToast('åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥', 'error');
        }
    }

    // è·å–çŠ¶æ€é¢œè‰²
    function getStatusColor(status) {
        const colors = {
            'completed': 'success',
            'waiting': 'warning',
            'indexing': 'info',
            'error': 'danger'
        };
        return colors[status] || 'secondary';
    }

    // è·å–çŠ¶æ€æ–‡æœ¬
    function getStatusText(status) {
        const texts = {
            'completed': 'å·²å®Œæˆ',
            'waiting': 'ç­‰å¾…ä¸­',
            'indexing': 'å¤„ç†ä¸­',
            'error': 'é”™è¯¯'
        };
        return texts[status] || 'æœªçŸ¥';
    }

    // åˆ›å»ºçŸ¥è¯†åº“
    async function createDataset() {
        const name = document.getElementById('dataset-name-input').value.trim();
        const description = document.getElementById('dataset-description-input').value.trim();
        
        if (!name) {
            showToast('è¯·è¾“å…¥çŸ¥è¯†åº“åç§°', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/datasets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    description: description
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'åˆ›å»ºå¤±è´¥');
            }
            
            const result = await response.json();
            showToast('çŸ¥è¯†åº“åˆ›å»ºæˆåŠŸ', 'success');
            
            // å…³é—­æ¨¡æ€æ¡†
            bootstrap.Modal.getInstance(document.getElementById('createDatasetModal')).hide();
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('create-dataset-form').reset();
            
            // åˆ·æ–°åˆ—è¡¨
            loadDatasets();
            
        } catch (error) {
            showToast(`åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
        }
    }

    // æ·»åŠ æ–‡æ¡£
    async function addDocument() {
        if (!currentDatasetId) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªçŸ¥è¯†åº“', 'warning');
            return;
        }
        
        const documentType = document.querySelector('input[name="document-type"]:checked').value;
        
        try {
            let response;
            
            if (documentType === 'text') {
                // æ–‡æœ¬æ–¹å¼æ·»åŠ 
                const name = document.getElementById('document-name-input').value.trim();
                const content = document.getElementById('document-content-input').value.trim();
                
                if (!name || !content) {
                    showToast('è¯·å¡«å†™å®Œæ•´çš„æ–‡æ¡£ä¿¡æ¯', 'warning');
                    return;
                }
                
                response = await fetch(`/api/datasets/${currentDatasetId}/documents`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        text: content
                    })
                });
            } else {
                // æ–‡ä»¶æ–¹å¼æ·»åŠ 
                const fileInput = document.getElementById('document-file-input');
                const file = fileInput.files[0];
                
                if (!file) {
                    showToast('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'warning');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                
                response = await fetch(`/api/datasets/${currentDatasetId}/documents`, {
                    method: 'POST',
                    body: formData
                });
            }
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'æ·»åŠ å¤±è´¥');
            }
            
            const result = await response.json();
            showToast('æ–‡æ¡£æ·»åŠ æˆåŠŸï¼Œå¼€å§‹å¤„ç†...', 'success');
            
            // å…³é—­æ¨¡æ€æ¡†
            bootstrap.Modal.getInstance(document.getElementById('addDocumentModal')).hide();
            
            // æ¸…ç©ºè¡¨å•
            resetDocumentForm();
            
            // åˆ·æ–°æ–‡æ¡£åˆ—è¡¨
            loadDocuments(currentDatasetId);
            
        } catch (error) {
            showToast(`æ·»åŠ å¤±è´¥: ${error.message}`, 'error');
        }
    }

    // é‡ç½®æ–‡æ¡£è¡¨å•
    function resetDocumentForm() {
        document.getElementById('add-document-text-form').reset();
        document.getElementById('add-document-file-form').reset();
        document.getElementById('document-char-count').textContent = '0';
        document.getElementById('file-preview').style.display = 'none';
        
        // é‡ç½®ä¸ºæ–‡æœ¬è¾“å…¥æ¨¡å¼
        document.getElementById('text-type').checked = true;
        toggleDocumentInputType('text');
    }

    // åˆ é™¤æ–‡æ¡£ç¡®è®¤
    function confirmDeleteDocument(documentId, documentName) {
        if (confirm(`ç¡®å®šè¦åˆ é™¤æ–‡æ¡£"${documentName}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
            deleteDocument(documentId);
        }
    }

    // åˆ é™¤æ–‡æ¡£
    async function deleteDocument(documentId) {
        try {
            const response = await fetch(`/api/datasets/${currentDatasetId}/documents/${documentId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'åˆ é™¤å¤±è´¥');
            }
            
            showToast('æ–‡æ¡£åˆ é™¤æˆåŠŸ', 'success');
            
            // åˆ·æ–°æ–‡æ¡£åˆ—è¡¨
            loadDocuments(currentDatasetId);
            
        } catch (error) {
            showToast(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
        }
    }

    // åˆ é™¤çŸ¥è¯†åº“ç¡®è®¤
    function confirmDeleteDataset() {
        if (!currentDatasetId) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªçŸ¥è¯†åº“', 'warning');
            return;
        }
        
        const datasetName = document.getElementById('dataset-title').textContent.replace(/.*?(\S+)$/, '$1');
        if (confirm(`ç¡®å®šè¦åˆ é™¤çŸ¥è¯†åº“"${datasetName}"å—ï¼Ÿæ­¤æ“ä½œå°†åˆ é™¤å…¶ä¸­çš„æ‰€æœ‰æ–‡æ¡£ï¼Œä¸”ä¸å¯æ¢å¤ã€‚`)) {
            deleteDataset(currentDatasetId);
        }
    }

    // åˆ é™¤çŸ¥è¯†åº“
    async function deleteDataset(datasetId) {
        try {
            const response = await fetch(`/api/datasets/${datasetId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'åˆ é™¤å¤±è´¥');
            }
            
            showToast('çŸ¥è¯†åº“åˆ é™¤æˆåŠŸ', 'success');
            
            // é‡ç½®ç•Œé¢
            currentDatasetId = null;
            document.getElementById('no-dataset-selected').style.display = 'block';
            document.getElementById('dataset-info').style.display = 'none';
            document.getElementById('documents-section').style.display = 'none';
            document.getElementById('dataset-actions').style.display = 'none';
            
            // åˆ·æ–°çŸ¥è¯†åº“åˆ—è¡¨
            loadDatasets();
            
        } catch (error) {
            showToast(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
        }
    }

    // åˆ·æ–°æ–‡æ¡£åˆ—è¡¨
    function refreshDocuments() {
        if (currentDatasetId) {
            loadDocuments(currentDatasetId);
        }
    }

    // æ£€ç´¢æµ‹è¯•
    function testRetrieval() {
        if (!currentDatasetId) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªçŸ¥è¯†åº“', 'warning');
            return;
        }
        
        // æ˜¾ç¤ºæ£€ç´¢æµ‹è¯•æ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('retrievalTestModal'));
        modal.show();
    }

    // æ‰§è¡Œæ£€ç´¢
    async function performRetrieval() {
        const query = document.getElementById('query-input').value.trim();
        
        if (!query) {
            showToast('è¯·è¾“å…¥æŸ¥è¯¢é—®é¢˜', 'warning');
            return;
        }
        
        try {
            showLoading();
            
            const response = await fetch(`/api/datasets/${currentDatasetId}/retrieve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: query,
                    top_k: 3,
                    score_threshold: 0.5
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'æ£€ç´¢å¤±è´¥');
            }
            
            const result = await response.json();
            
            document.getElementById('retrieval-results').style.display = 'block';
            
            if (result.records && result.records.length > 0) {
                document.getElementById('retrieval-content').innerHTML = `
                    <div class="mb-3">
                        <strong>æ£€ç´¢é—®é¢˜:</strong> ${query}
                    </div>
                    <div class="mb-3">
                        <strong>æ‰¾åˆ° ${result.records.length} ä¸ªç›¸å…³ç‰‡æ®µ:</strong>
                    </div>
                    ${result.records.map((record, index) => `
                        <div class="card mb-2">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">ç‰‡æ®µ ${index + 1}</h6>
                                    <span class="badge bg-success">${(record.score * 100).toFixed(1)}%</span>
                                </div>
                                <p class="card-text small">${record.segment.content}</p>
                                <small class="text-muted">
                                    <i class="fas fa-file me-1"></i>${record.segment.document.name}
                                </small>
                            </div>
                        </div>
                    `).join('')}
                `;
            } else {
                document.getElementById('retrieval-content').innerHTML = `
                    <div class="text-center py-3 text-muted">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <div>æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</div>
                        <small>è¯·å°è¯•å…¶ä»–å…³é”®è¯æˆ–æ·»åŠ æ›´å¤šæ–‡æ¡£</small>
                    </div>
                `;
            }
            
        } catch (error) {
            showToast(`æ£€ç´¢å¤±è´¥: ${error.message}`, 'error');
        } finally {
            hideLoading();
        }
    }
</script>

<style>
    .dataset-item {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .dataset-item:hover {
        background-color: #f8f9fa;
    }
    
    .dataset-item.active {
        background-color: #e3f2fd;
        border-color: #2196f3;
    }
    
    .list-group-item {
        border-left: 3px solid transparent;
    }
    
    .list-group-item.active {
        border-left-color: #007bff;
    }
</style>
{% endblock %} 