{% extends "base.html" %}

{% block title %}学术对话助手 - 大模型智慧文献阅读管理平台{% endblock %}

{% block content %}
<div class="container-fluid vh-100 p-0">
    <div class="row h-100 g-0">
        <!-- 会话列表侧边栏 -->
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-12 bg-white border-end h-100 d-flex flex-column" id="conversations-sidebar">
            <div class="d-flex flex-column h-100">
                <!-- 侧边栏头部 -->
                <div class="p-3 border-bottom flex-shrink-0">
                    <button class="btn btn-primary w-100" onclick="startNewConversation()">
                        <i class="fas fa-plus me-2"></i>新建对话
                    </button>
                </div>
                
                <!-- 会话列表 -->
                <div class="flex-grow-1 p-2 d-flex flex-column" id="conversations-list">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <div class="mt-2 text-muted">加载会话列表...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主聊天区域 -->
        <div class="col-xl-10 col-lg-9 col-md-8 col-sm-12 d-flex flex-column" style="height: 100vh;">
            <!-- 聊天头部 - 固定在顶部 -->
            <div class="bg-white border-bottom p-3 flex-shrink-0">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1" id="chat-title">学术对话助手</h5>
                        <small class="text-muted" id="chat-subtitle">选择一个会话开始学术讨论</small>
                    </div>
                    <div class="btn-group">
                        <!-- 移动端显示/隐藏侧边栏按钮 -->
                        <button class="btn btn-outline-secondary btn-sm d-md-none" onclick="toggleSidebar()" title="切换侧边栏">
                            <i class="fas fa-bars"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearCurrentChat()" title="清空当前对话">
                            <i class="fas fa-eraser"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="exportChat()" title="导出对话">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 消息展示区域 - 可滚动的中间区域 -->
            <div class="flex-grow-1 position-relative" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); overflow: hidden;">
                <div class="h-100 p-3">
                    <div class="messages-wrapper h-100" id="messages-wrapper">
                        <div class="text-center py-5" id="welcome-message">
                            <div class="mb-4">
                                <i class="fas fa-graduation-cap fa-3x text-primary mb-3"></i>
                                <h4>欢迎使用学术对话助手</h4>
                                <p class="text-muted">我是您的专属学术研究助手，可以帮您进行文献讨论、学术问答、研究指导等</p>
                            </div>
                            
                            <!-- 示例问题卡片组 -->
                            <div class="row justify-content-center">
                                <div class="col-lg-10">
                                    <div class="row g-3">
                                        <!-- 文献研究类 -->
                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h6 class="card-title">
                                                        <i class="fas fa-book-open text-primary me-2"></i>文献研究
                                                    </h6>
                                                    <div class="d-grid gap-2">
                                                        <button class="btn btn-outline-primary btn-sm" onclick="analyzeDocument()">
                                                            <i class="fas fa-search me-1"></i>分析论文核心观点
                                                        </button>
                                                        <button class="btn btn-outline-primary btn-sm" onclick="sendSampleMessage('这个研究领域有哪些经典文献？')">
                                                            <i class="fas fa-star me-1"></i>推荐经典文献
                                                        </button>
                                                        <button class="btn btn-outline-primary btn-sm" onclick="sendSampleMessage('如何撰写文献综述？')">
                                                            <i class="fas fa-edit me-1"></i>文献综述撰写
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 学术写作类 -->
                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h6 class="card-title">
                                                        <i class="fas fa-pen-nib text-success me-2"></i>学术写作
                                                    </h6>
                                                    <div class="d-grid gap-2">
                                                        <button class="btn btn-outline-success btn-sm" onclick="sendSampleMessage('请帮我改进这段论文摘要的表达')">
                                                            <i class="fas fa-magic me-1"></i>优化论文摘要
                                                        </button>
                                                        <button class="btn btn-outline-success btn-sm" onclick="sendSampleMessage('如何提高学术论文的逻辑性？')">
                                                            <i class="fas fa-sitemap me-1"></i>提升论文逻辑
                                                        </button>
                                                        <button class="btn btn-outline-success btn-sm" onclick="sendSampleMessage('学术论文的引用格式有哪些？')">
                                                            <i class="fas fa-quote-right me-1"></i>引用格式指导
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 研究方法类 -->
                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h6 class="card-title">
                                                        <i class="fas fa-flask text-info me-2"></i>研究方法
                                                    </h6>
                                                    <div class="d-grid gap-2">
                                                        <button class="btn btn-outline-info btn-sm" onclick="sendSampleMessage('定量研究和定性研究的区别是什么？')">
                                                            <i class="fas fa-chart-bar me-1"></i>研究方法对比
                                                        </button>
                                                        <button class="btn btn-outline-info btn-sm" onclick="sendSampleMessage('如何设计一个有效的实验方案？')">
                                                            <i class="fas fa-cogs me-1"></i>实验设计指导
                                                        </button>
                                                        <button class="btn btn-outline-info btn-sm" onclick="sendSampleMessage('数据分析中的常见统计方法有哪些？')">
                                                            <i class="fas fa-calculator me-1"></i>统计方法介绍
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 学术翻译类 -->
                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h6 class="card-title">
                                                        <i class="fas fa-language text-warning me-2"></i>学术翻译
                                                    </h6>
                                                    <div class="d-grid gap-2">
                                                        <button class="btn btn-outline-warning btn-sm" onclick="sendSampleMessage('请帮我翻译这段学术文本，保持专业性')">
                                                            <i class="fas fa-exchange-alt me-1"></i>专业翻译
                                                        </button>
                                                        <button class="btn btn-outline-warning btn-sm" onclick="sendSampleMessage('这个专业术语的准确翻译是什么？')">
                                                            <i class="fas fa-book me-1"></i>术语翻译
                                                        </button>
                                                        <button class="btn btn-outline-warning btn-sm" onclick="sendSampleMessage('如何提高英文学术写作水平？')">
                                                            <i class="fas fa-globe me-1"></i>英文写作提升
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 快速开始提示 -->
                            <div class="mt-4">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    提示：您可以点击任意示例问题快速开始，或直接输入您的学术问题
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 输入区域 - 固定在底部 -->
            <div class="bg-white border-top p-3 flex-shrink-0 position-relative">
                <!-- 停止生成按钮 - 位于输入框上方中间 -->
                <div class="position-absolute w-100 d-flex justify-content-center" id="stop-generation-btn" style="display: none !important; bottom: 100%; left: 0; z-index: 1000; margin-bottom: 10px;">
                    <button class="btn btn-outline-secondary shadow-sm stop-btn" onclick="stopGeneration()" style="border-radius: 20px; padding: 8px 16px; background: white; border: 1px solid #ddd;">
                        <i class="fas fa-stop me-2"></i>停止生成
                    </button>
                </div>
                
                <!-- 文件上传区域 -->
                <div id="file-upload-area" class="mb-3">
                    <!-- 已上传文件预览 -->
                    <div id="uploaded-files-preview" class="d-none">
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            <div id="file-preview-card" class="border rounded-3 p-2 bg-white shadow-sm d-flex align-items-center" 
                                 style="max-width: 100%; border: 1px solid #e3f2fd !important; background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%) !important;">
                                <div id="file-icon" class="me-2 text-center" style="width: 32px;">
                                    <i class="fas fa-file text-muted"></i>
                                </div>
                                <div class="flex-grow-1 text-truncate">
                                    <div id="file-name" class="fw-medium small text-truncate text-primary"></div>
                                    <div class="d-flex align-items-center">
                                        <div id="file-size" class="text-muted me-2" style="font-size: 0.7rem;"></div>
                                        <span class="badge bg-success" style="font-size: 0.6rem;">已上传</span>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-link text-muted p-1 ms-2" onclick="removeFile()" title="移除文件">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 隐藏的文件输入框 -->
                    <input type="file" id="file-input" 
                           accept=".txt,.pdf,.doc,.docx,.xls,.xlsx,.csv,.md,.html,.png,.jpg,.jpeg,.gif,.webp,.svg,.mp3,.m4a,.wav,.webm,.amr,.mp4,.mov,.mpeg,.mpga" 
                           style="display: none;" 
                           onchange="handleFileUpload(this)">
                </div>
                
                <!-- 提示词快捷按钮 -->
                <div id="prompt-suggestions" class="mb-3">
                    <div class="d-flex flex-wrap gap-1">
                        <button type="button" class="btn btn-outline-secondary btn-sm prompt-btn" onclick="summarizeDocument()">
                            <i class="fas fa-list-ul me-1"></i>详细总结
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm prompt-btn" onclick="explainDocument()">
                            <i class="fas fa-comments me-1"></i>通俗解释
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm prompt-btn" onclick="extractKeyPoints()">
                            <i class="fas fa-key me-1"></i>提取要点
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm prompt-btn" onclick="translateDocument()">
                            <i class="fas fa-language me-1"></i>翻译文档
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm prompt-btn" onclick="analyzeStructure()">
                            <i class="fas fa-sitemap me-1"></i>分析结构
                        </button>
                    </div>
                </div>
                
                <form id="message-form" class="d-flex align-items-end">
                    <div class="flex-grow-1 me-2">
                        <div class="position-relative">
                            <textarea class="form-control border-0 shadow-sm" id="message-input" 
                                     placeholder="输入您的问题..." rows="1" 
                                     style="resize: none; border-radius: 20px; padding: 12px 50px 12px 16px; background: #f8f9fa;"></textarea>
                            <div class="position-absolute top-50 end-0 translate-middle-y me-3">
                                <button type="button" class="btn btn-link p-1 text-muted" 
                                        onclick="document.getElementById('file-input').click()" 
                                        title="上传文件">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center" 
                                id="send-button" style="width: 40px; height: 40px;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    var currentConversationId = '{{ conversation_id }}';
    var uploadedFile = null;
    var isStreaming = false;
    var currentAbortController = null;
    var currentEventSource = null;
    var currentTaskId = null;

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        loadConversations();
        if (currentConversationId) {
            loadConversationMessages(currentConversationId);
        }
        
        // 绑定表单提交事件
        document.getElementById('message-form').addEventListener('submit', handleSubmit);
        
        // 绑定输入框事件
        const messageInput = document.getElementById('message-input');
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSubmit(e);
            }
        });
        
        // 自适应文本框高度
        messageInput.addEventListener('input', function() {
            autoResizeTextarea(this);
        });
    });

    // 加载会话列表
    async function loadConversations() {
        try {
            const response = await fetch('/api/conversations');
            const data = await response.json();
            
            const container = document.getElementById('conversations-list');
            
            if (data.data && data.data.length > 0) {
                container.innerHTML = data.data.map(conv => `
                    <div class="conversation-item ${conv.id === currentConversationId ? 'active' : ''}" 
                         onclick="selectConversation('${conv.id}', '${conv.name}')" 
                         data-id="${conv.id}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="fw-bold text-truncate">${conv.name || '新对话'}</div>
                                <small class="text-muted">${formatTime(conv.created_at)}</small>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-comments fa-2x mb-2"></i>
                        <div>暂无对话</div>
                        <small>点击"新建对话"开始</small>
                    </div>
                `;
            }
        } catch (error) {
            console.error('加载会话列表失败:', error);
        }
    }

    // 选择会话
    function selectConversation(conversationId, conversationName) {
        currentConversationId = conversationId;
        
        // 更新活跃状态
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-id="${conversationId}"]`).classList.add('active');
        
        // 更新标题
        document.getElementById('chat-title').textContent = conversationName || '学术对话助手';
        document.getElementById('chat-subtitle').textContent = `会话ID: ${conversationId}`;
        
        // 加载消息
        loadConversationMessages(conversationId);
        
        // 隐藏欢迎消息
        document.getElementById('welcome-message').style.display = 'none';
    }

    // 加载会话消息
    async function loadConversationMessages(conversationId) {
        try {
            const response = await fetch(`/api/conversations/${conversationId}/messages`);
            const data = await response.json();
            
            const wrapper = document.getElementById('messages-wrapper');
            
            if (data.data && data.data.length > 0) {
                wrapper.innerHTML = data.data.reverse().map(msg => {
                    return `
                        <div class="message-group mb-3">
                            <!-- 用户消息 -->
                            <div class="d-flex justify-content-end mb-2">
                                <div class="message user-message">
                                    <div class="message-content">${msg.query}</div>
                                    <small class="text-muted">${formatTime(msg.created_at)}</small>
                                </div>
                            </div>
                            <!-- AI回复 -->
                            <div class="d-flex justify-content-start">
                                <div class="message ai-message">
                                    <div class="message-content">${msg.answer}</div>
                                    <div class="message-actions mt-2">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard(\`${msg.answer}\`)">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-success">
                                            <i class="fas fa-thumbs-up"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">${formatTime(msg.created_at)}</small>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // 滚动到底部
                smoothScrollToBottom();
            }
        } catch (error) {
            console.error('加载消息失败:', error);
        }
    }

    // 开始新对话
    function startNewConversation() {
        currentConversationId = '';
        document.getElementById('chat-title').textContent = '新学术对话';
        document.getElementById('chat-subtitle').textContent = '开始新的学术讨论';
        
        // 显示欢迎消息和示例问题
        showWelcomeMessage();
        
        // 移除活跃状态
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
        });
    }

    // 显示欢迎消息和示例问题
    function showWelcomeMessage() {
        document.getElementById('messages-wrapper').innerHTML = `
            <div class="text-center py-4" id="welcome-message">
                <div class="mb-4">
                    <i class="fas fa-graduation-cap fa-3x text-primary mb-3"></i>
                    <h4>欢迎使用学术对话助手</h4>
                    <p class="text-muted">我是您的专属学术研究助手，可以帮您进行文献讨论、学术问答、研究指导等</p>
                </div>
                
                <!-- 示例问题卡片组 -->
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <div class="row g-3">
                            <!-- 文献研究类 -->
                            <div class="col-md-6">
                                <div class="card h-100 sample-card">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-book-open text-primary me-2"></i>文献研究
                                        </h6>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary btn-sm" onclick="analyzeDocument()">
                                                <i class="fas fa-search me-1"></i>分析论文核心观点
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm" onclick="sendSampleMessage('这个研究领域有哪些经典文献？')">
                                                <i class="fas fa-star me-1"></i>推荐经典文献
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm" onclick="sendSampleMessage('如何撰写文献综述？')">
                                                <i class="fas fa-edit me-1"></i>文献综述撰写
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 学术写作类 -->
                            <div class="col-md-6">
                                <div class="card h-100 sample-card">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-pen-nib text-success me-2"></i>学术写作
                                        </h6>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-success btn-sm" onclick="sendSampleMessage('请帮我改进这段论文摘要的表达')">
                                                <i class="fas fa-magic me-1"></i>优化论文摘要
                                            </button>
                                            <button class="btn btn-outline-success btn-sm" onclick="sendSampleMessage('如何提高学术论文的逻辑性？')">
                                                <i class="fas fa-sitemap me-1"></i>提升论文逻辑
                                            </button>
                                            <button class="btn btn-outline-success btn-sm" onclick="sendSampleMessage('学术论文的引用格式有哪些？')">
                                                <i class="fas fa-quote-right me-1"></i>引用格式指导
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 研究方法类 -->
                            <div class="col-md-6">
                                <div class="card h-100 sample-card">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-flask text-info me-2"></i>研究方法
                                        </h6>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-info btn-sm" onclick="sendSampleMessage('定量研究和定性研究的区别是什么？')">
                                                <i class="fas fa-chart-bar me-1"></i>研究方法对比
                                            </button>
                                            <button class="btn btn-outline-info btn-sm" onclick="sendSampleMessage('如何设计一个有效的实验方案？')">
                                                <i class="fas fa-cogs me-1"></i>实验设计指导
                                            </button>
                                            <button class="btn btn-outline-info btn-sm" onclick="sendSampleMessage('数据分析中的常见统计方法有哪些？')">
                                                <i class="fas fa-calculator me-1"></i>统计方法介绍
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 学术翻译类 -->
                            <div class="col-md-6">
                                <div class="card h-100 sample-card">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-language text-warning me-2"></i>学术翻译
                                        </h6>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-warning btn-sm" onclick="sendSampleMessage('请帮我翻译这段学术文本，保持专业性')">
                                                <i class="fas fa-exchange-alt me-1"></i>专业翻译
                                            </button>
                                            <button class="btn btn-outline-warning btn-sm" onclick="sendSampleMessage('这个专业术语的准确翻译是什么？')">
                                                <i class="fas fa-book me-1"></i>术语翻译
                                            </button>
                                            <button class="btn btn-outline-warning btn-sm" onclick="sendSampleMessage('如何提高英文学术写作水平？')">
                                                <i class="fas fa-globe me-1"></i>英文写作提升
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 快速开始提示 -->
                <div class="mt-4">
                    <small class="text-muted">
                        <i class="fas fa-lightbulb me-1"></i>
                        提示：您可以点击任意示例问题快速开始，或直接输入您的学术问题
                    </small>
                </div>
            </div>
        `;
    }

    // 处理表单提交
    function handleSubmit(e) {
        e.preventDefault();
        
        if (isStreaming) {
            showToast('请等待当前消息处理完成', 'warning');
            return;
        }
        
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        
        if (!message) {
            showToast('请输入消息内容', 'warning');
            return;
        }
        
        sendMessage(message);
        messageInput.value = '';
        autoResizeTextarea(messageInput);
    }

    // 发送消息
    async function sendMessage(message) {
        if (isStreaming) return;
        
        isStreaming = true;
        document.getElementById('send-button').disabled = true;
        // 显示停止按钮（覆盖 display: none !important）
        const stopBtn = document.getElementById('stop-generation-btn');
        stopBtn.style.setProperty('display', 'block', 'important');
        
        // 隐藏欢迎消息
        const welcomeMsg = document.getElementById('welcome-message');
        if (welcomeMsg) {
            welcomeMsg.style.display = 'none';
        }
        
        // 添加用户消息到界面
        addMessage(message, 'user');
        
        // 添加AI消息占位符
        const aiMessageId = addMessage('', 'ai', true);
        
        try {
            // 构建请求数据
            let queryMessage = message;
            const requestData = {
                query: queryMessage,
                conversation_id: currentConversationId
            };
            
            // 如果有上传的文件，根据文件类型添加到inputs中
            if (uploadedFile) {
                // 根据输入格式文档，文件应该放在inputs中
                if (uploadedFile.type === 'image') {
                    // 图片文件放在inputs.input_image中
                    requestData.inputs = {
                        input_image: {
                            type: uploadedFile.type,
                            transfer_method: uploadedFile.transfer_method,
                            upload_file_id: uploadedFile.upload_file_id
                        }
                    };
                } else {
                    // 其他文件类型也放在inputs中，使用通用的文件字段
                    requestData.inputs = {
                        input_file: {
                            type: uploadedFile.type,
                            transfer_method: uploadedFile.transfer_method,
                            upload_file_id: uploadedFile.upload_file_id
                        }
                    };
                }
            }
            
            // 创建可取消的请求
            currentAbortController = new AbortController();
            
            const response = await fetch('/api/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData),
                signal: currentAbortController.signal
            });
            
            if (!response.ok) {
                throw new Error('发送消息失败');
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let fullContent = '';
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // 保留不完整的行
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            
                            // 获取task_id
                            if (data.task_id) {
                                currentTaskId = data.task_id;
                            }
                            
                            if (data.event === 'message') {
                                fullContent += data.answer || '';
                                updateMessage(aiMessageId, fullContent);
                                
                                // 更新会话ID
                                if (data.conversation_id && !currentConversationId) {
                                    currentConversationId = data.conversation_id;
                                }
                            } else if (data.event === 'message_end') {
                                // 消息结束，完成消息
                                finishMessage(aiMessageId, fullContent);
                                
                                // 更新会话ID
                                if (data.conversation_id) {
                                    currentConversationId = data.conversation_id;
                                }
                            }
                        } catch (e) {
                            console.error('解析SSE数据失败:', e);
                        }
                    }
                }
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('请求被取消');
                updateMessage(aiMessageId, fullContent + '\n\n[回答已停止]');
                finishMessage(aiMessageId, fullContent + '\n\n[回答已停止]');
            } else {
                console.error('发送消息失败:', error);
                updateMessage(aiMessageId, '抱歉，发送消息时出现错误，请稍后重试。');
                finishMessage(aiMessageId, '抱歉，发送消息时出现错误，请稍后重试。');
                showToast('发送消息失败', 'error');
            }
        } finally {
            isStreaming = false;
            document.getElementById('send-button').disabled = false;
            // 隐藏停止按钮
            const stopBtn = document.getElementById('stop-generation-btn');
            stopBtn.style.setProperty('display', 'none', 'important');
            currentAbortController = null;
            currentTaskId = null;
            
            // 清理上传的文件
            if (uploadedFile) {
                removeFile();
            }
        }
    }

    // 添加消息到界面
    function addMessage(content, type, isStreaming = false) {
        const wrapper = document.getElementById('messages-wrapper');
        const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const timestamp = new Date().toLocaleString('zh-CN');
        
        let messageHtml = '';
        
        if (type === 'user') {
            // 构建用户消息内容
            let userContent = content;
            let fileInfo = '';
            
            // 如果有上传的文件，在气泡下方显示文件信息
            if (uploadedFile) {
                const fileName = document.getElementById('file-name').textContent;
                fileInfo = `<div class="file-upload-info mt-1">${fileName} 已上传</div>`;
            }
            
            messageHtml = `
                <div class="message-group mb-4 animate__animated animate__fadeInUp animate__faster">
                    <div class="d-flex justify-content-end align-items-start">
                        <div class="user-message-container">
                            <div class="message user-message">
                                <div class="message-content">${userContent}</div>
                            </div>
                            ${fileInfo}
                            <div class="message-time text-end mt-1">${timestamp}</div>
                        </div>
                        <div class="user-avatar ms-3">
                            <div class="avatar-circle user-avatar-bg">
                                <span class="avatar-text">你</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            messageHtml = `
                <div class="message-group mb-4 animate__animated animate__fadeInUp animate__faster">
                    <div class="d-flex justify-content-start align-items-start">
                        <div class="ai-avatar me-3">
                            <div class="avatar-circle ai-avatar-bg">
                                <i class="fas fa-robot"></i>
                            </div>
                        </div>
                        <div class="ai-message-container flex-grow-1">
                            <div class="message ai-message" id="${messageId}">
                                <div class="message-content">${content}${isStreaming ? '<span class="typing-indicator">正在输入...</span>' : ''}</div>
                            </div>
                            <div class="message-time mt-1">${timestamp}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        wrapper.insertAdjacentHTML('beforeend', messageHtml);
        
        // 自动滚动到底部
        setTimeout(() => {
            smoothScrollToBottom();
        }, 100);
        
        return messageId;
    }

    // 更新消息内容
    function updateMessage(messageId, content) {
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
            const contentElement = messageElement.querySelector('.message-content');
            contentElement.innerHTML = content + '<span class="typing-indicator">正在输入...</span>';
            
            // 滚动到底部
            scrollToBottom();
        }
    }

    // 完成消息
    function finishMessage(messageId, content) {
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
            const contentElement = messageElement.querySelector('.message-content');
            contentElement.innerHTML = content;
            
            // 添加操作按钮
            const actionsHtml = `
                <div class="message-actions d-flex gap-1 flex-wrap">
                    <button class="btn" onclick="copyToClipboard(\`${content.replace(/`/g, '\\`')}\`)" title="复制内容">
                        <i class="fas fa-copy me-1"></i>复制
                    </button>
                    <button class="btn" title="有用">
                        <i class="fas fa-thumbs-up me-1"></i>好评
                    </button>
                    <button class="btn" title="无用">
                        <i class="fas fa-thumbs-down me-1"></i>差评
                    </button>
                    <button class="btn" onclick="regenerateResponse('${messageId}')" title="重新生成">
                        <i class="fas fa-redo me-1"></i>重新生成
                    </button>
                </div>
            `;
            
            // 将操作按钮添加到ai-message-container中
            const messageContainer = messageElement.closest('.ai-message-container');
            if (messageContainer) {
                messageContainer.insertAdjacentHTML('beforeend', actionsHtml);
            }
        }
    }

    // 停止生成回答
    async function stopGeneration() {
        // 如果有task_id，向后端发送停止请求
        if (currentTaskId) {
            try {
                const response = await fetch('/api/chat/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        task_id: currentTaskId
                    })
                });
                
                if (response.ok) {
                    showToast('已停止生成', 'info');
                } else {
                    console.error('停止请求失败:', response.status);
                }
            } catch (error) {
                console.error('发送停止请求失败:', error);
            }
        }
        
        // 取消前端请求
        if (currentAbortController) {
            currentAbortController.abort();
        }
        if (currentEventSource) {
            currentEventSource.close();
            currentEventSource = null;
        }
        
        // 立即完成当前消息，移除打字动效
        const currentMessages = document.querySelectorAll('.message-content .typing-indicator');
        currentMessages.forEach(indicator => {
            const messageContent = indicator.parentElement;
            const currentText = messageContent.textContent.replace('正在输入...', '').trim();
            if (currentText) {
                messageContent.innerHTML = currentText;
                // 找到对应的消息ID并完成消息
                const messageElement = messageContent.closest('.message');
                if (messageElement && messageElement.id) {
                    finishMessage(messageElement.id, currentText);
                }
            }
        });
        
        isStreaming = false;
        document.getElementById('send-button').disabled = false;
        // 隐藏停止按钮
        const stopBtn = document.getElementById('stop-generation-btn');
        stopBtn.style.setProperty('display', 'none', 'important');
        currentAbortController = null;
        currentTaskId = null;
    }

    // 发送示例消息
    function sendSampleMessage(message) {
        document.getElementById('message-input').value = message;
        handleSubmit(new Event('submit'));
    }

    // 文件上传处理
    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        
        // 检查文件大小 (50MB限制)
        if (file.size > 50 * 1024 * 1024) {
            showToast('文件大小不能超过50MB', 'error');
            input.value = '';
            return;
        }
        
        // 显示加载提示
        showToast('正在上传文件...', 'info');
        
        // 创建FormData
        const formData = new FormData();
        formData.append('file', file);
        
        // 上传文件
        fetch('/api/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.file) {
                // 所有文件都上传到Dify，统一处理
                uploadedFile = {
                    type: data.file.type,  // 'image', 'document', 'audio', 'video', 'custom'
                    transfer_method: data.file.transfer_method,  // 'local_file'
                    upload_file_id: data.file.id  // Dify文件ID
                };
                
                // 显示文件预览
                displayFilePreview(data.file, data.file_type);
                showToast(`${data.file_type === 'image' ? '图片' : data.file_type === 'document' ? '文档' : '文件'}上传成功`, 'success');
            } else {
                showToast(data.error || '文件上传失败', 'error');
                input.value = '';
            }
        })
        .catch(error => {
            console.error('文件上传错误:', error);
            showToast('文件上传失败', 'error');
            input.value = '';
        });
    }
    
    // 显示文件预览
    function displayFilePreview(fileData, fileType) {
        const fileName = fileData.name;
        const fileSize = fileData.size;
        const fileExtension = fileData.extension;
        
        // 设置文件图标
        const iconElement = document.getElementById('file-icon');
        let iconClass = 'fas fa-file';
        let iconColor = 'text-primary';
        
        if (fileType === 'image') {
            iconClass = 'fas fa-image';
            iconColor = 'text-success';
        } else if (fileType === 'document') {
            if (fileExtension === 'pdf') {
                iconClass = 'fas fa-file-pdf';
                iconColor = 'text-danger';
            } else if (['doc', 'docx'].includes(fileExtension)) {
                iconClass = 'fas fa-file-word';
                iconColor = 'text-primary';
            } else if (['xls', 'xlsx'].includes(fileExtension)) {
                iconClass = 'fas fa-file-excel';
                iconColor = 'text-success';
            } else if (['txt', 'md', 'mdx', 'markdown'].includes(fileExtension)) {
                iconClass = 'fas fa-file-alt';
                iconColor = 'text-info';
            } else if (['html', 'xml'].includes(fileExtension)) {
                iconClass = 'fab fa-html5';
                iconColor = 'text-warning';
            } else if (fileExtension === 'csv') {
                iconClass = 'fas fa-file-csv';
                iconColor = 'text-success';
            }
        } else if (fileType === 'audio') {
            iconClass = 'fas fa-file-audio';
            iconColor = 'text-info';
        } else if (fileType === 'video') {
            iconClass = 'fas fa-file-video';
            iconColor = 'text-primary';
        }
        
        iconElement.innerHTML = `<i class="${iconClass} ${iconColor}"></i>`;
        
        // 设置文件信息
        document.getElementById('file-name').textContent = fileName;
        document.getElementById('file-size').textContent = formatFileSize(fileSize);
        
        // 显示文件预览
        document.getElementById('uploaded-files-preview').classList.remove('d-none');
    }

    // 移除文件
    function removeFile() {
        uploadedFile = null;
        document.getElementById('uploaded-files-preview').classList.add('d-none');
        document.getElementById('file-input').value = '';
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 自适应文本框高度
    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        const newHeight = Math.min(Math.max(textarea.scrollHeight, 40), 120);
        textarea.style.height = newHeight + 'px';
    }

    // 其他功能函数
    function clearCurrentChat() {
        if (confirm('确定要清空当前对话吗？')) {
            // 重新显示欢迎消息和示例问题
            showWelcomeMessage();
            currentConversationId = '';
            showToast('对话已清空', 'success');
        }
    }

    function exportChat() {
        showToast('导出功能开发中...', 'info');
    }
    
    // 复制到剪贴板
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('内容已复制到剪贴板', 'success');
        }).catch(() => {
            showToast('复制失败', 'error');
        });
    }
    
    // 重新生成回答
    function regenerateResponse(messageId) {
        showToast('重新生成功能开发中...', 'info');
    }
    
    // 切换侧边栏显示（移动端）
    function toggleSidebar() {
        const sidebar = document.getElementById('conversations-sidebar');
        const mainArea = sidebar.nextElementSibling;
        
        if (sidebar.classList.contains('d-none')) {
            sidebar.classList.remove('d-none');
            mainArea.classList.add('d-none');
        } else {
            sidebar.classList.add('d-none');
            mainArea.classList.remove('d-none');
        }
    }
    
    // 显示toast提示
    function showToast(message, type = 'info') {
        // 创建toast容器（如果不存在）
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        const toastId = 'toast-' + Date.now();
        const iconMap = {
            success: 'fa-check-circle text-success',
            error: 'fa-exclamation-circle text-danger',
            warning: 'fa-exclamation-triangle text-warning',
            info: 'fa-info-circle text-info'
        };
        
        const toastHtml = `
            <div class="toast animate__animated animate__fadeInRight" id="${toastId}" role="alert">
                <div class="toast-body d-flex align-items-center">
                    <i class="fas ${iconMap[type]} me-2"></i>
                    <span class="flex-grow-1">${message}</span>
                    <button type="button" class="btn-close ms-2" onclick="closeToast('${toastId}')"></button>
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // 3秒后自动关闭
        setTimeout(() => closeToast(toastId), 3000);
    }
    
    // 关闭toast
    function closeToast(toastId) {
        const toast = document.getElementById(toastId);
        if (toast) {
            toast.classList.add('animate__fadeOutRight');
            setTimeout(() => toast.remove(), 300);
        }
    }
    
    // 格式化时间
    function formatTime(timestamp) {
        return new Date(timestamp * 1000).toLocaleString('zh-CN');
    }

    // 自动滚动到底部
    function scrollToBottom() {
        const wrapper = document.getElementById('messages-wrapper');
        if (wrapper) {
            wrapper.scrollTop = wrapper.scrollHeight;
        }
    }

    // 平滑滚动到底部
    function smoothScrollToBottom() {
        const wrapper = document.getElementById('messages-wrapper');
        if (wrapper) {
            wrapper.scrollTo({
                top: wrapper.scrollHeight,
                behavior: 'smooth'
            });
        }
    }

    // 分析文档功能
    function analyzeDocument() {
        // 检查是否已上传文件
        if (!uploadedFile) {
            // 显示提示并触发文件上传
            showToast('请先上传要分析的论文文档', 'warning');
            document.getElementById('file-input').click();
            
            // 监听文件上传完成事件
            const fileInput = document.getElementById('file-input');
            const originalOnChange = fileInput.onchange;
            
            fileInput.onchange = function(event) {
                // 执行原有的文件上传处理
                if (originalOnChange) {
                    originalOnChange.call(this, event);
                }
                
                // 文件上传完成后，延迟执行分析
                setTimeout(() => {
                    if (uploadedFile) {
                        executeDocumentAnalysis();
                    }
                }, 1000);
                
                // 恢复原有的onchange事件
                fileInput.onchange = originalOnChange;
            };
        } else {
            // 如果已有文件，直接执行分析
            executeDocumentAnalysis();
        }
    }

    // 执行文档分析
    function executeDocumentAnalysis() {
        const analysisPrompt = "请帮我分析这篇论文的核心观点和创新点，包括：\n1. 主要研究问题和目标\n2. 核心观点和理论贡献\n3. 创新点和突破\n4. 研究方法和技术路线\n5. 主要结论和意义";
        
        // 将分析提示填入输入框
        const messageInput = document.getElementById('message-input');
        messageInput.value = analysisPrompt;
        autoResizeTextarea(messageInput);
        
        // 自动发送消息
        setTimeout(() => {
            handleSubmit(new Event('submit'));
        }, 500);
    }

    // 其他文档处理功能
    function summarizeDocument() {
        if (!uploadedFile) {
            showToast('请先上传要总结的文档', 'warning');
            document.getElementById('file-input').click();
            return;
        }
        
        const summaryPrompt = "请详细总结这个文档的内容，包括主要观点、关键信息和重要结论。";
        const messageInput = document.getElementById('message-input');
        messageInput.value = summaryPrompt;
        autoResizeTextarea(messageInput);
        
        setTimeout(() => {
            handleSubmit(new Event('submit'));
        }, 500);
    }

    function explainDocument() {
        if (!uploadedFile) {
            showToast('请先上传要解释的文档', 'warning');
            document.getElementById('file-input').click();
            return;
        }
        
        const explainPrompt = "用通俗易懂的话，说说这个文档讲了什么，让非专业人士也能理解。";
        const messageInput = document.getElementById('message-input');
        messageInput.value = explainPrompt;
        autoResizeTextarea(messageInput);
        
        setTimeout(() => {
            handleSubmit(new Event('submit'));
        }, 500);
    }

    function extractKeyPoints() {
        if (!uploadedFile) {
            showToast('请先上传要分析的文档', 'warning');
            document.getElementById('file-input').click();
            return;
        }
        
        const extractPrompt = "提取这个文档中的关键信息和要点，以条目形式列出。";
        const messageInput = document.getElementById('message-input');
        messageInput.value = extractPrompt;
        autoResizeTextarea(messageInput);
        
        setTimeout(() => {
            handleSubmit(new Event('submit'));
        }, 500);
    }

    function translateDocument() {
        if (!uploadedFile) {
            showToast('请先上传要翻译的文档', 'warning');
            document.getElementById('file-input').click();
            return;
        }
        
        const translatePrompt = "翻译这个文档的内容，保持专业术语的准确性。";
        const messageInput = document.getElementById('message-input');
        messageInput.value = translatePrompt;
        autoResizeTextarea(messageInput);
        
        setTimeout(() => {
            handleSubmit(new Event('submit'));
        }, 500);
    }

    function analyzeStructure() {
        if (!uploadedFile) {
            showToast('请先上传要分析的文档', 'warning');
            document.getElementById('file-input').click();
            return;
        }
        
        const structurePrompt = "分析这个文档的结构和逻辑，包括章节安排、论证思路和内容组织方式。";
        const messageInput = document.getElementById('message-input');
        messageInput.value = structurePrompt;
        autoResizeTextarea(messageInput);
        
        setTimeout(() => {
            handleSubmit(new Event('submit'));
        }, 500);
    }
</script>

<style>
    /* 隐藏所有滚动条 */
    * {
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
    }
    
    *::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }
    
    /* 消息区域样式 */
    .messages-wrapper {
        overflow-y: auto; /* 允许垂直滚动 */
        padding-bottom: 20px; /* 底部留一些空间 */
        display: flex;
        flex-direction: column;
    }
    
    /* 会话列表样式 */
    #conversations-list {
        overflow-y: auto; /* 允许会话列表滚动 */
    }
    
    /* 消息组样式 */
    .message-group {
        flex-shrink: 0; /* 防止消息被压缩 */
    }
    
    /* 固定布局样式 */
    .chat-container {
        height: 100vh;
        overflow: hidden;
    }
    
    .chat-header {
        height: 80px;
        z-index: 100;
    }
    
    .chat-messages {
        top: 80px;
        bottom: 140px;
        overflow: hidden;
    }
    
    .chat-input {
        height: 140px;
        z-index: 100;
    }
    
    /* 移动端响应式调整 */
    @media (max-width: 768px) {
        .chat-header {
            height: 70px;
        }
        
        .chat-messages {
            top: 70px;
            bottom: 120px;
        }
        
        .chat-input {
            height: 120px;
        }
        
        /* 移动端隐藏侧边栏，全屏显示聊天区域 */
        #conversations-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1050;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        #conversations-sidebar:not(.d-none) {
            transform: translateX(0);
        }
        
        .user-message-container {
            max-width: 85%;
        }
        
        .ai-message-container {
            max-width: 90%;
        }
        
        .message {
            padding: 10px 14px;
            font-size: 14px;
            max-width: 85%;
        }
        
        .avatar-circle {
            width: 28px;
            height: 28px;
            font-size: 12px;
        }
        
        .avatar-text {
            font-size: 10px;
        }
        
        .message-actions .btn {
            font-size: 10px;
            padding: 3px 6px;
        }
        
        .stop-btn {
            font-size: 13px;
            padding: 6px 12px;
        }
        
        .sample-card .btn {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        
        .sample-card {
            margin-bottom: 1rem;
        }
        
        /* 移动端输入框优化 */
        #message-input {
            font-size: 16px; /* 防止iOS缩放 */
        }
        
        /* 移动端提示词按钮优化 */
        .prompt-btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
    }
    
    /* 提示词按钮样式 */
    .prompt-btn {
        border-radius: 20px;
        font-size: 0.8rem;
        padding: 0.3rem 0.8rem;
        transition: all 0.2s ease;
        border: 1px solid #dee2e6;
        background: white;
        color: #6c757d;
    }
    
    .prompt-btn:hover {
        background: #f8f9fa;
        border-color: #007bff;
        color: #007bff;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,123,255,0.1);
    }
    
    .prompt-btn:active {
        transform: translateY(0);
    }
    
    .prompt-btn i {
        font-size: 0.7rem;
    }
    
    /* 会话列表样式优化 */
    .conversation-item {
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }
    
    .conversation-item:hover {
        background-color: #f8f9fa;
        border-color: #e9ecef;
    }
    
    .conversation-item.active {
        background-color: #e3f2fd;
        border-color: #2196f3;
    }
    
    /* 头像样式 */
    .avatar-circle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 14px;
        font-weight: 500;
    }
    
    .user-avatar-bg {
        background-color: #19c37d;
        color: white;
    }
    
    .ai-avatar-bg {
        background-color: #ab68ff;
        color: white;
    }
    
    .avatar-text {
        font-size: 12px;
        font-weight: 600;
    }
    
    /* 消息容器样式 */
    .user-message-container {
        max-width: 85%;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }
    
    .ai-message-container {
        max-width: 85%;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }
    
    /* 消息气泡样式 */
    .message {
        padding: 12px 16px;
        border-radius: 18px;
        margin-bottom: 4px;
        word-wrap: break-word;
        line-height: 1.5;
        font-size: 15px;
        max-width: 100%;
        width: fit-content;
    }
    
    .user-message {
        background-color: #f0f0f0;
        color: #333333;
        border-bottom-right-radius: 4px;
    }
    
    .ai-message {
        background-color: #f7f7f8;
        color: #0d0d0d;
        border: none;
        border-bottom-left-radius: 4px;
    }
    
    /* 消息内容样式 */
    .message-content {
        word-wrap: break-word;
        white-space: pre-wrap;
    }
    
    /* 用户消息内容左对齐 */
    .user-message .message-content {
        text-align: left;
    }
    
    /* AI消息内容保持左对齐 */
    .ai-message .message-content {
        text-align: left;
    }
    
    .message-time {
        font-size: 11px;
        color: #6b7280;
        opacity: 0.8;
    }
    
    /* 消息操作按钮 */
    .message-actions {
        opacity: 0;
        transition: all 0.2s ease;
        margin-top: 8px;
    }
    
    .ai-message-container:hover .message-actions {
        opacity: 1;
    }
    
    .message-actions .btn {
        font-size: 11px;
        padding: 4px 8px;
        transition: all 0.2s ease;
        border: none;
        background: transparent;
        color: #6b7280;
    }
    
    .message-actions .btn:hover {
        background-color: #f3f4f6;
        color: #374151;
        transform: scale(1.05);
    }
    
    /* 打字指示器 */
    .typing-indicator {
        color: #9ca3af;
        font-size: 0.9em;
        font-style: italic;
        margin-left: 8px;
        opacity: 0.8;
        position: relative;
    }
    
    .typing-indicator::after {
        content: '';
        display: inline-block;
        width: 4px;
        height: 1em;
        background-color: #9ca3af;
        margin-left: 4px;
        animation: blink 1.2s infinite;
        vertical-align: text-bottom;
    }
    
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
    }
    
    /* 停止按钮样式 */
    .stop-btn {
        transition: all 0.2s ease;
        font-size: 14px;
        font-weight: 500;
        color: #6b7280;
        border-color: #d1d5db;
        opacity: 0;
        animation: fadeInUp 0.3s ease-out forwards;
    }
    
    .stop-btn:hover {
        background-color: #f3f4f6;
        border-color: #9ca3af;
        color: #374151;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stop-btn:active {
        transform: translateY(0);
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* 文件上传信息样式 */
    .file-upload-info {
        font-size: 12px;
        color: #666;
        opacity: 0.8;
    }
</style>
{% endblock %} 