{% extends "base.html" %}

{% block title %}æ™ºèƒ½ç¿»è¯‘ - Difyæ™ºèƒ½åŠ©æ‰‹{% endblock %}

{% block page_title %}ğŸ“„ æ–‡çŒ®å¤„ç†{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-1 text-dark fw-bold">
                        <i class="fas fa-language me-2 text-primary"></i>æ–‡çŒ®ç¿»è¯‘åŠ©æ‰‹
                    </h3>
                    <p class="text-muted mb-0">æ”¯æŒå¤šç§ç¿»è¯‘æ¨¡å¼å’ŒAIæ™ºèƒ½å¤„ç†</p>
                </div>
                <div class="d-flex align-items-center">
                    <small class="text-muted me-2">å½“å‰æœåŠ¡ï¼š</small>
                    <span class="badge bg-secondary" id="provider-status">
                        <i class="fas fa-spinner fa-spin me-1"></i>æ£€æµ‹ä¸­...
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½é€‰æ‹©åŒºåŸŸ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <!-- åŠŸèƒ½æ¨¡å¼é€‰æ‹© -->
                    <div class="d-flex flex-wrap gap-2 mb-4" id="mode-selector">
                        <button type="button" class="btn btn-outline-primary active px-4 rounded-pill" data-mode="translate">
                            <i class="fas fa-language me-2"></i>æ–‡æœ¬ç¿»è¯‘
                        </button>
                        <button type="button" class="btn btn-outline-secondary px-4 rounded-pill" data-mode="document_translate">
                            <i class="fas fa-file-alt me-2"></i>æ–‡æ¡£ç¿»è¯‘
                        </button>
                        <button type="button" class="btn btn-outline-success px-4 rounded-pill" data-mode="image_translate">
                            <i class="fas fa-image me-2"></i>å›¾ç‰‡ç¿»è¯‘
                        </button>
                        <button type="button" class="btn btn-outline-warning px-4 rounded-pill" data-mode="domain_translate">
                            <i class="fas fa-graduation-cap me-2"></i>é¢†åŸŸç¿»è¯‘
                        </button>
                        <button type="button" class="btn btn-outline-info px-4 rounded-pill" data-mode="ai_translate">
                            <i class="fas fa-brain me-2"></i>AIç¿»è¯‘
                        </button>
                        <button type="button" class="btn btn-outline-danger px-4 rounded-pill" data-mode="grammar_check">
                            <i class="fas fa-spell-check me-2"></i>è¯­æ³•æ£€æŸ¥
                        </button>
                        <button type="button" class="btn btn-outline-dark px-4 rounded-pill" data-mode="summary">
                            <i class="fas fa-compress-alt me-2"></i>æ™ºèƒ½æ€»ç»“
                        </button>
                        <button type="button" class="btn btn-outline-purple px-4 rounded-pill" data-mode="rewrite">
                            <i class="fas fa-edit me-2"></i>æ–‡æ®µæ”¹å†™
                        </button>
                    </div>

                    <!-- è¯­è¨€é€‰æ‹©åŒºåŸŸ -->
                    <div class="row g-3" id="language-controls">
                        <div class="col-lg-5">
                            <label class="form-label text-muted fw-semibold">æºè¯­è¨€</label>
                            <select class="form-select form-select-lg border-2" id="from-language">
                                <option value="auto">è‡ªåŠ¨æ£€æµ‹è¯­è¨€</option>
                            </select>
                        </div>
                        <div class="col-lg-2 d-flex align-items-end justify-content-center">
                            <button type="button" class="btn btn-outline-primary btn-lg rounded-circle" id="swap-languages" title="äº¤æ¢è¯­è¨€ (åŒå‡»è¯­è¨€é€‰æ‹©æ¡†æˆ–æŒ‰Ctrl+Shift+S)">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                        <div class="col-lg-5">
                            <label class="form-label text-muted fw-semibold">ç›®æ ‡è¯­è¨€</label>
                            <select class="form-select form-select-lg border-2" id="to-language">
                                <option value="zh">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option>
                            </select>
                        </div>
                    </div>

                    <!-- é¢†åŸŸé€‰æ‹©ï¼ˆä»…åœ¨é¢†åŸŸç¿»è¯‘æ—¶æ˜¾ç¤ºï¼‰ -->
                    <div class="row g-3 mt-2 d-none" id="domain-selection">
                        <div class="col-12">
                            <label class="form-label text-muted fw-semibold">
                                <i class="fas fa-graduation-cap me-2"></i>ä¸“ä¸šé¢†åŸŸ
                            </label>
                            <select class="form-select" id="translation-domain">
                                <option value="it">ä¿¡æ¯æŠ€æœ¯</option>
                                <option value="finance">é‡‘èè´¢ç»</option>
                                <option value="machinery">æœºæ¢°åˆ¶é€ </option>
                                <option value="senimed">ç”Ÿç‰©åŒ»è¯</option>
                                <option value="academic">å­¦æœ¯è®ºæ–‡</option>
                                <option value="aerospace">èˆªç©ºèˆªå¤©</option>
                                <option value="wiki">äººæ–‡ç¤¾ç§‘</option>
                                <option value="news">æ–°é—»èµ„è®¯</option>
                                <option value="law">æ³•å¾‹æ³•è§„</option>
                                <option value="contract">åˆåŒåè®®</option>
                                <option value="novel">ç½‘ç»œæ–‡å­¦</option>
                            </select>
                            <small class="text-muted">é€‰æ‹©ä¸“ä¸šé¢†åŸŸå¯è·å¾—æ›´å‡†ç¡®çš„ç¿»è¯‘ç»“æœ</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å·¥ä½œåŒºåŸŸ -->
    <div class="row g-4">
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-muted fw-semibold">
                        <i class="fas fa-edit me-2"></i>è¾“å…¥å†…å®¹
                    </h6>
                    <div class="d-flex align-items-center gap-3">
                        <small class="text-muted">
                            <span id="char-count">0</span> / 5000 å­—ç¬¦
                        </small>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clear-input" title="æ¸…ç©º">
                                <i class="fas fa-times"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="paste-text" title="ç²˜è´´">
                                <i class="fas fa-paste"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body pt-2 pb-2">
                    <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                    <div id="image-upload-area" class="d-none">
                        <div class="border-2 border-dashed border-primary rounded-3 p-4 text-center mb-3 upload-zone">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <p class="mb-2 fw-semibold">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </p>
                            <input type="file" class="form-control" id="image-upload" accept="image/*" style="display: none;">
                            <button type="button" class="btn btn-primary btn-lg px-4" onclick="document.getElementById('image-upload').click()">
                                <i class="fas fa-upload me-2"></i>é€‰æ‹©å›¾ç‰‡
                            </button>
                            <small class="d-block text-muted mt-3">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤§ 10MB</small>
                        </div>
                        <div id="image-preview" class="d-none text-center">
                            <img class="img-fluid rounded shadow" style="max-height: 300px;">
                            <div class="mt-2">
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeImage()">
                                    <i class="fas fa-trash me-1"></i>ç§»é™¤å›¾ç‰‡
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- æ–‡æ¡£ä¸Šä¼ åŒºåŸŸ -->
                    <div id="document-upload-area" class="d-none">
                        <div class="border-2 border-dashed border-secondary rounded-3 p-4 text-center mb-3 upload-zone">
                            <i class="fas fa-file-upload fa-3x text-secondary mb-3"></i>
                            <p class="mb-2 fw-semibold">æ‹–æ‹½æ–‡æ¡£åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </p>
                            <input type="file" class="form-control" id="document-upload" accept=".doc,.docx,.pdf,.txt,.html,.htm,.xls,.xlsx,.ppt,.pptx,.xml" style="display: none;">
                            <button type="button" class="btn btn-secondary btn-lg px-4" onclick="document.getElementById('document-upload').click()">
                                <i class="fas fa-upload me-2"></i>é€‰æ‹©æ–‡æ¡£
                            </button>
                            <small class="d-block text-muted mt-3">æ”¯æŒ DOCã€DOCXã€PDFã€TXTã€HTMLã€XLSã€XLSXã€PPTã€PPTXã€XML æ ¼å¼ï¼Œæœ€å¤§ 50MB</small>
                        </div>
                        <div id="document-preview" class="d-none">
                            <div class="card border-secondary">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-file fa-2x text-secondary me-3"></i>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1" id="document-name">æ–‡ä»¶å.docx</h6>
                                            <small class="text-muted" id="document-size">æ–‡ä»¶å¤§å°: 0 KB</small>
                                        </div>
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeDocument()">
                                            <i class="fas fa-trash me-1"></i>ç§»é™¤
                                        </button>
                                    </div>
                                    <div class="mt-3">
                                        <div class="progress" style="height: 3px;">
                                            <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%" id="upload-progress"></div>
                                        </div>
                                        <small class="text-muted" id="upload-status">å‡†å¤‡ä¸Šä¼ ...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ–‡æœ¬è¾“å…¥åŒºåŸŸ -->
                    <div id="text-input-area">
                        <textarea class="form-control border-0" 
                                 id="input-text" 
                                 rows="16" 
                                 placeholder="åœ¨æ­¤è¾“å…¥éœ€è¦å¤„ç†çš„æ–‡æœ¬å†…å®¹..."
                                 style="font-size: 16px; line-height: 1.6; box-shadow: none;"></textarea>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-secondary" id="voice-input" title="è¯­éŸ³è¾“å…¥">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="file-upload" title="ä¸Šä¼ æ–‡ä»¶">
                                <i class="fas fa-file-upload"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" id="clear-input-btn" title="æ¸…ç©ºè¾“å…¥">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        <button type="button" class="btn btn-primary btn-lg px-5 fw-semibold" id="process-btn">
                            <i class="fas fa-arrow-right me-2"></i>å¼€å§‹ç¿»è¯‘
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¾“å‡ºåŒºåŸŸ -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-muted fw-semibold">
                        <i class="fas fa-check-circle me-2"></i>å¤„ç†ç»“æœ
                    </h6>
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm d-none" id="copy-result" title="å¤åˆ¶ç»“æœ">
                            <i class="fas fa-copy me-1"></i>å¤åˆ¶
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm d-none" id="download-result" title="ä¸‹è½½ç»“æœ">
                            <i class="fas fa-download me-1"></i>ä¸‹è½½
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm d-none" id="clear-result-btn" title="æ¸…ç©ºç»“æœ">
                            <i class="fas fa-trash-alt me-1"></i>æ¸…ç©º
                        </button>
                    </div>
                </div>
                <div class="card-body pt-2 pb-2">
                    <div id="result-area">
                        <!-- é»˜è®¤æç¤º -->
                        <div id="result-placeholder" class="text-center py-5">
                            <i class="fas fa-magic fa-4x text-muted mb-4"></i>
                            <h5 class="text-muted fw-bold">å¤„ç†ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</h5>
                            <p class="text-muted mb-0">é€‰æ‹©åŠŸèƒ½å¹¶è¾“å…¥å†…å®¹å¼€å§‹ä½¿ç”¨</p>
                        </div>

                        <!-- åŠ è½½çŠ¶æ€ -->
                        <div id="loading-state" class="text-center py-5 d-none">
                            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">å¤„ç†ä¸­...</span>
                            </div>
                            <h6 class="text-muted fw-bold">æ­£åœ¨å¤„ç†ä¸­...</h6>
                            <p class="text-muted mb-0">è¯·ç¨å€™ï¼Œæ­£åœ¨ç¿»è¯‘ï¼Œè¯·ç¨ç­‰â€¦â€¦</p>
                        </div>

                        <!-- ç»“æœæ˜¾ç¤º - ä»…åŒ…å«å¯æ»šåŠ¨çš„æ–‡æœ¬å†…å®¹ -->
                        <div id="result-content" class="d-none">
                            <div class="result-text p-4 rounded-3" style="font-size: 16px; line-height: 1.7; min-height: 350px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #dee2e6;">
                                <!-- ç»“æœå†…å®¹ -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç»“æœç»Ÿè®¡ - å›ºå®šåœ¨åº•éƒ¨ï¼Œä¸å‚ä¸æ»šåŠ¨ -->
                <div class="card-footer bg-transparent border-0 pt-2" id="result-stats" style="display: none;">
                    <div class="row g-3">
                        <div class="col-4 text-center">
                            <div class="p-3 bg-light rounded">
                                <small class="text-muted d-block">å¤„ç†æ—¶é—´</small>
                                <div class="fw-bold text-primary" id="process-time">-</div>
                            </div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="p-3 bg-light rounded">
                                <small class="text-muted d-block">å­—ç¬¦æ•°</small>
                                <div class="fw-bold text-success" id="result-chars">-</div>
                            </div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="p-3 bg-light rounded">
                                <small class="text-muted d-block">æœåŠ¡</small>
                                <div class="fw-bold text-info" id="service-used">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«æ·ç¤ºä¾‹åŒºåŸŸ -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 pb-2">
                    <h6 class="mb-0 text-muted fw-semibold">
                        <i class="fas fa-bolt me-2"></i>å¿«æ·ç¤ºä¾‹
                    </h6>
                </div>
                <div class="card-body pt-2">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <button type="button" class="btn btn-light w-100 h-100 text-start p-3" onclick="setQuickText('Hello, how are you today?')">
                                <i class="fas fa-comment text-primary mb-2 fa-lg"></i>
                                <div class="fw-bold mb-1">æ—¥å¸¸å¯¹è¯</div>
                                <small class="text-muted">Hello, how are you today?</small>
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-light w-100 h-100 text-start p-3" onclick="setQuickText('Artificial intelligence is transforming various industries.')">
                                <i class="fas fa-graduation-cap text-success mb-2 fa-lg"></i>
                                <div class="fw-bold mb-1">å­¦æœ¯æ–‡æœ¬</div>
                                <small class="text-muted">Artificial intelligence is...</small>
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-light w-100 h-100 text-start p-3" onclick="setQuickText('The meeting is scheduled for tomorrow at 2 PM.')">
                                <i class="fas fa-briefcase text-warning mb-2 fa-lg"></i>
                                <div class="fw-bold mb-1">å•†åŠ¡ç”¨è¯­</div>
                                <small class="text-muted">The meeting is scheduled...</small>
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-light w-100 h-100 text-start p-3" onclick="setQuickText('æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªé‡è¦åˆ†æ”¯ï¼Œå®ƒæ¨¡æ‹Ÿäººè„‘çš„ç¥ç»ç½‘ç»œç»“æ„ã€‚')">
                                <i class="fas fa-cogs text-info mb-2 fa-lg"></i>
                                <div class="fw-bold mb-1">æŠ€æœ¯æ–‡æ¡£</div>
                                <small class="text-muted">æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ ...</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* è‡ªå®šä¹‰æ ·å¼ */
.card {
    transition: all 0.3s ease;
    border-radius: 1rem !important;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
}

.btn[data-mode] {
    transition: all 0.3s ease;
    border-width: 2px;
    font-weight: 600;
}

.btn[data-mode].active {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0,123,255,0.3);
}

.btn[data-mode]:hover {
    transform: translateY(-1px);
}

.form-select, .form-control {
    border-radius: 0.75rem;
    transition: all 0.3s ease;
}

.form-select:focus, .form-control:focus {
    border-color: #4dabf7;
    box-shadow: 0 0 0 0.2rem rgba(77,171,247,0.25);
    transform: translateY(-1px);
}

.upload-zone {
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-zone:hover {
    background-color: rgba(13,110,253,0.1);
    border-color: #4dabf7 !important;
}

#input-text {
    background: transparent;
    transition: all 0.3s ease;
}

#input-text:focus {
    background: rgba(248,249,250,0.5);
}

.result-text {
    transition: all 0.3s ease;
    word-wrap: break-word;
    white-space: pre-wrap;
}

.spinner-border {
    border-width: 3px;
}

/* è¯­è¨€äº¤æ¢æŒ‰é’®æ ·å¼ */
#swap-languages {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

#swap-languages:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
}

#swap-languages:active {
    transform: scale(0.95);
}

#swap-languages::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: all 0.3s ease;
}

#swap-languages:hover::before {
    width: 100px;
    height: 100px;
}

#swap-languages i {
    transition: transform 0.3s ease;
    z-index: 1;
    position: relative;
}

/* æ·±è‰²æ¨¡å¼ä¸‹çš„è¯­è¨€äº¤æ¢æŒ‰é’® */
[data-theme="dark"] #swap-languages {
    border-color: #60a5fa !important;
    color: #60a5fa !important;
}

[data-theme="dark"] #swap-languages:hover {
    background-color: #60a5fa !important;
    border-color: #60a5fa !important;
    color: #ffffff !important;
    box-shadow: 0 4px 15px rgba(96, 165, 250, 0.4);
}

[data-theme="dark"] #swap-languages::before {
    background: rgba(96, 165, 250, 0.2);
}

/* ===========================================
   æ·±è‰²æ¨¡å¼æ ·å¼ - æ–‡çŒ®å¤„ç†é¡µé¢ä¸“ç”¨
   =========================================== */

/* æ·±è‰²æ¨¡å¼åŸºç¡€è°ƒæ•´ */
[data-theme="dark"] .card:hover {
    box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
}

[data-theme="dark"] .btn[data-mode].active {
    box-shadow: 0 4px 15px rgba(77,171,247,0.4);
}

/* æ·±è‰²æ¨¡å¼æ–‡æœ¬é¢œè‰² */
[data-theme="dark"] .text-dark {
    color: #f1f5f9 !important;
}

[data-theme="dark"] .fw-bold {
    color: #f1f5f9 !important;
}

/* å¾½ç« å’ŒçŠ¶æ€æŒ‡ç¤ºå™¨ */
[data-theme="dark"] .badge.bg-secondary {
    background-color: #475569 !important;
    color: #e2e8f0 !important;
}

[data-theme="dark"] .badge.bg-primary {
    background-color: #3b82f6 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .badge.bg-info {
    background-color: #06b6d4 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .badge.bg-success {
    background-color: #10b981 !important;
    color: #ffffff !important;
}

/* åŠŸèƒ½æ¨¡å¼æŒ‰é’® */
[data-theme="dark"] .btn-outline-secondary {
    border-color: #64748b !important;
    color: #cbd5e1 !important;
}

[data-theme="dark"] .btn-outline-secondary:hover {
    background-color: #64748b !important;
    border-color: #64748b !important;
    color: #ffffff !important;
}

[data-theme="dark"] .btn-outline-success {
    border-color: #22c55e !important;
    color: #22c55e !important;
}

[data-theme="dark"] .btn-outline-success:hover {
    background-color: #22c55e !important;
    border-color: #22c55e !important;
}

[data-theme="dark"] .btn-outline-warning {
    border-color: #f59e0b !important;
    color: #f59e0b !important;
}

[data-theme="dark"] .btn-outline-warning:hover {
    background-color: #f59e0b !important;
    border-color: #f59e0b !important;
}

[data-theme="dark"] .btn-outline-dark {
    border-color: #6b7280 !important;
    color: #9ca3af !important;
}

[data-theme="dark"] .btn-outline-dark:hover {
    background-color: #6b7280 !important;
    border-color: #6b7280 !important;
    color: #ffffff !important;
}

/* è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡† */
[data-theme="dark"] .form-select {
    background-color: #374151 !important;
    border-color: #4b5563 !important;
    color: #e5e7eb !important;
}

[data-theme="dark"] .form-select:focus {
    background-color: #374151 !important;
    border-color: #60a5fa !important;
    box-shadow: 0 0 0 0.2rem rgba(96, 165, 250, 0.25) !important;
}

[data-theme="dark"] #input-text {
    background-color: #374151 !important;
    border-color: #4b5563 !important;
    color: #e5e7eb !important;
}

[data-theme="dark"] #input-text:focus {
    background-color: #374151 !important;
    border-color: #60a5fa !important;
    box-shadow: 0 0 0 0.2rem rgba(96, 165, 250, 0.25) !important;
}

[data-theme="dark"] #input-text::placeholder {
    color: #9ca3af !important;
}

/* ä¸Šä¼ åŒºåŸŸ */
[data-theme="dark"] .upload-zone {
    border-color: #4b5563 !important;
    background-color: #1f2937 !important;
}

[data-theme="dark"] .upload-zone:hover {
    background-color: rgba(96, 165, 250, 0.1) !important;
    border-color: #60a5fa !important;
}

[data-theme="dark"] .border-primary {
    border-color: #3b82f6 !important;
}

[data-theme="dark"] .border-secondary {
    border-color: #6b7280 !important;
}

[data-theme="dark"] .text-primary {
    color: #60a5fa !important;
}

[data-theme="dark"] .text-secondary {
    color: #9ca3af !important;
}

/* è¿›åº¦æ¡ */
[data-theme="dark"] .progress {
    background-color: #374151 !important;
}

[data-theme="dark"] .progress-bar {
    background-color: #3b82f6 !important;
}

[data-theme="dark"] .bg-secondary {
    background-color: #6b7280 !important;
}

/* ç»“æœåŒºåŸŸ */
[data-theme="dark"] .result-text {
    color: #e5e7eb !important;
    background-color: transparent !important;
}

[data-theme="dark"] #result-placeholder {
    color: #9ca3af !important;
}

[data-theme="dark"] #result-placeholder i {
    color: #6b7280 !important;
}

[data-theme="dark"] #result-placeholder h5 {
    color: #9ca3af !important;
}

/* å¿«æ·æ–‡æœ¬æŒ‰é’® */
[data-theme="dark"] .btn-light {
    background-color: #374151 !important;
    border-color: #4b5563 !important;
    color: #e5e7eb !important;
}

[data-theme="dark"] .btn-light:hover {
    background-color: #4b5563 !important;
    border-color: #6b7280 !important;
    color: #f3f4f6 !important;
}

/* å›¾æ ‡é¢œè‰²è°ƒæ•´ */
[data-theme="dark"] .text-success {
    color: #22c55e !important;
}

[data-theme="dark"] .text-warning {
    color: #f59e0b !important;
}

[data-theme="dark"] .text-info {
    color: #06b6d4 !important;
}

[data-theme="dark"] .text-danger {
    color: #ef4444 !important;
}

/* åŠ è½½çŠ¶æ€ */
[data-theme="dark"] .spinner-border {
    color: #60a5fa !important;
}

[data-theme="dark"] #loading-state {
    color: #cbd5e1 !important;
}

/* å­—ç¬¦è®¡æ•°å™¨ */
[data-theme="dark"] #char-count {
    color: #9ca3af !important;
}

/* å·¥å…·æç¤ºå’Œå°æ–‡æœ¬ */
[data-theme="dark"] small {
    color: #9ca3af !important;
}

/* ç»“æœç»Ÿè®¡åŒºåŸŸ */
[data-theme="dark"] .bg-light {
    background-color: #374151 !important;
}

[data-theme="dark"] .bg-light .text-muted {
    color: #9ca3af !important;
}

[data-theme="dark"] .bg-light .fw-bold {
    color: #e5e7eb !important;
}

[data-theme="dark"] .result-text {
    background: linear-gradient(135deg, #374151 0%, #4b5563 100%) !important;
    border-color: #6b7280 !important;
}

/* å›¾ç‰‡é¢„è§ˆ */
[data-theme="dark"] #image-preview img {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5) !important;
}

/* æ–‡æ¡£é¢„è§ˆå¡ç‰‡ */
[data-theme="dark"] .card.border-secondary {
    border-color: #6b7280 !important;
}

/* é€æ˜èƒŒæ™¯çš„å¡ç‰‡å¤´éƒ¨ */
[data-theme="dark"] .card-header.bg-transparent {
    background-color: transparent !important;
    color: #e5e7eb !important;
}

/* éšè—/æ˜¾ç¤ºå…ƒç´ çš„çŠ¶æ€ä¿æŒ */
[data-theme="dark"] .d-none {
    display: none !important;
}

/* æ·±è‰²æ¨¡å¼ç»“æœç»Ÿè®¡åŒºåŸŸ */
[data-theme="dark"] #result-stats {
    border-top-color: #4b5563 !important;
}

/* ä¿®å¤æ·±è‰²æ¨¡å¼ä¸‹çš„æ–‡å­—é¢œè‰²é—®é¢˜ */
[data-theme="dark"] .mb-0.text-muted.fw-semibold {
    color: #e5e7eb !important;
}

[data-theme="dark"] h6.mb-0.text-muted.fw-semibold {
    color: #e5e7eb !important;
}

/* æ·±è‰²æ¨¡å¼ä¸‹æ ‡é¢˜å›¾æ ‡é¢œè‰² */
[data-theme="dark"] .card-header h6 i {
    color: #9ca3af !important;
}

/* ===========================================
   æ»šåŠ¨åŒºåŸŸæ ·å¼
   =========================================== */

/* è¾“å…¥å’Œè¾“å‡ºåŒºåŸŸæ·»åŠ æ»šåŠ¨æ¡ */
.col-lg-6 .card-body.pt-2.pb-2 {
    max-height: 600px;
    overflow-y: auto;
    overflow-x: hidden;
}

/* æ–‡æœ¬è¾“å…¥åŒºåŸŸæ»šåŠ¨ */
#text-input-area {
    max-height: 500px;
    overflow-y: auto;
}

#input-text {
    min-height: 400px;
    max-height: none;
    resize: vertical;
}

/* ç»“æœåŒºåŸŸæ»šåŠ¨ */
#result-area {
    max-height: 470px;
    overflow-y: auto;
    overflow-x: hidden;
}

.result-text {
    max-height: none;
    min-height: 300px;
}

/* ç»“æœç»Ÿè®¡åŒºåŸŸå›ºå®šæ ·å¼ */
#result-stats {
    background-color: transparent;
    border-top: 1px solid #dee2e6;
    margin-top: 0;
}

/* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ - æµ…è‰²æ¨¡å¼ */
.col-lg-6 .card-body.pt-2.pb-2::-webkit-scrollbar,
#text-input-area::-webkit-scrollbar,
#result-area::-webkit-scrollbar {
    width: 8px;
}

.col-lg-6 .card-body.pt-2.pb-2::-webkit-scrollbar-track,
#text-input-area::-webkit-scrollbar-track,
#result-area::-webkit-scrollbar-track {
    background: #f1f3f4;
    border-radius: 10px;
}

.col-lg-6 .card-body.pt-2.pb-2::-webkit-scrollbar-thumb,
#text-input-area::-webkit-scrollbar-thumb,
#result-area::-webkit-scrollbar-thumb {
    background: #c1c7cd;
    border-radius: 10px;
}

.col-lg-6 .card-body.pt-2.pb-2::-webkit-scrollbar-thumb:hover,
#text-input-area::-webkit-scrollbar-thumb:hover,
#result-area::-webkit-scrollbar-thumb:hover {
    background: #a8b0b8;
}

/* æ·±è‰²æ¨¡å¼æ»šåŠ¨æ¡æ ·å¼ */
[data-theme="dark"] .col-lg-6 .card-body.pt-2.pb-2::-webkit-scrollbar-track,
[data-theme="dark"] #text-input-area::-webkit-scrollbar-track,
[data-theme="dark"] #result-area::-webkit-scrollbar-track {
    background: #374151;
}

[data-theme="dark"] .col-lg-6 .card-body.pt-2.pb-2::-webkit-scrollbar-thumb,
[data-theme="dark"] #text-input-area::-webkit-scrollbar-thumb,
[data-theme="dark"] #result-area::-webkit-scrollbar-thumb {
    background: #6b7280;
}

[data-theme="dark"] .col-lg-6 .card-body.pt-2.pb-2::-webkit-scrollbar-thumb:hover,
[data-theme="dark"] #text-input-area::-webkit-scrollbar-thumb:hover,
[data-theme="dark"] #result-area::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .btn[data-mode] {
        font-size: 0.875rem;
        padding: 0.75rem 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    .card-body {
        padding: 1.5rem !important;
    }
    
    .col-lg-5, .col-lg-2 {
        margin-bottom: 1rem;
    }
    
    #swap-languages {
        margin: 0 auto 1rem auto;
    }
    
    /* ç§»åŠ¨ç«¯æ»šåŠ¨åŒºåŸŸé«˜åº¦è°ƒæ•´ */
    .col-lg-6 .card-body.pt-2.pb-2 {
        max-height: 400px;
    }
    
    #text-input-area {
        max-height: 350px;
    }
    
    #input-text {
        min-height: 250px;
    }
    
    #result-area {
        max-height: 280px;
    }
    
    .result-text {
        min-height: 200px;
    }
}

/* åŠ¨ç”»æ•ˆæœ */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card {
    animation: fadeInUp 0.6s ease;
}

#result-content {
    animation: fadeInUp 0.4s ease;
}
</style>

<script>
// å…¨å±€å˜é‡
let isProcessing = false;
let currentMode = 'translate';
let startTime = 0;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

// åˆå§‹åŒ–åº”ç”¨
function initializeApp() {
    bindEvents();
    loadTranslationConfig();
    updateCharCount();
    updateModeDisplay();
    
    // å»¶è¿Ÿæ˜¾ç¤ºåŠŸèƒ½æç¤º
    setTimeout(() => {
        if (document.getElementById('from-language').options.length > 1) {
            showLanguageSwapHint();
        }
    }, 2000);
}

// æ˜¾ç¤ºè¯­è¨€äº¤æ¢åŠŸèƒ½æç¤º
function showLanguageSwapHint() {
    const swapButton = document.getElementById('swap-languages');
    if (!swapButton) return;
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºè¿‡æç¤º
    if (localStorage.getItem('languageSwapHintShown')) return;
    
    // åˆ›å»ºæç¤ºæ°”æ³¡
    const hint = document.createElement('div');
    hint.className = 'language-swap-hint';
    hint.innerHTML = `
        <div class="hint-content">
            <i class="fas fa-lightbulb text-warning me-2"></i>
            <strong>æç¤ºï¼š</strong>ç‚¹å‡»ä¸­é—´æŒ‰é’®å¯å¿«é€Ÿäº¤æ¢æºè¯­è¨€å’Œç›®æ ‡è¯­è¨€ï¼
            <button type="button" class="btn-close btn-close-white ms-2" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    hint.style.cssText = `
        position: absolute;
        top: -60px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        font-size: 0.85rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        opacity: 0;
        animation: fadeInUp 0.5s ease forwards;
        max-width: 300px;
        white-space: nowrap;
    `;
    
    // æ·»åŠ ç®­å¤´
    const arrow = document.createElement('div');
    arrow.style.cssText = `
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 6px solid #667eea;
    `;
    hint.appendChild(arrow);
    
    // æ·»åŠ CSSåŠ¨ç”»
    if (!document.querySelector('#language-swap-hint-styles')) {
        const styles = document.createElement('style');
        styles.id = 'language-swap-hint-styles';
        styles.textContent = `
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateX(-50%) translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
            }
            .language-swap-hint .hint-content {
                display: flex;
                align-items: center;
            }
        `;
        document.head.appendChild(styles);
    }
    
    // æ·»åŠ åˆ°äº¤æ¢æŒ‰é’®å®¹å™¨
    const buttonContainer = swapButton.parentElement;
    buttonContainer.style.position = 'relative';
    buttonContainer.appendChild(hint);
    
    // 5ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        if (hint.parentElement) {
            hint.style.opacity = '0';
            hint.style.transform = 'translateX(-50%) translateY(-10px)';
            setTimeout(() => {
                if (hint.parentElement) {
                    hint.parentElement.removeChild(hint);
                }
            }, 300);
        }
    }, 5000);
    
    // æ ‡è®°ä¸ºå·²æ˜¾ç¤º
    localStorage.setItem('languageSwapHintShown', 'true');
}

// ç»‘å®šäº‹ä»¶
function bindEvents() {
    // å­—ç¬¦è®¡æ•°
    document.getElementById('input-text').addEventListener('input', updateCharCount);
    
    // åŠŸèƒ½æ¨¡å¼åˆ‡æ¢
    document.querySelectorAll('[data-mode]').forEach(btn => {
        btn.addEventListener('click', function() {
            switchMode(this.dataset.mode);
        });
    });
    
    // è¯­è¨€äº¤æ¢
    document.getElementById('swap-languages').addEventListener('click', swapLanguages);
    
    // åŒå‡»è¯­è¨€é€‰æ‹©æ¡†ä¹Ÿå¯ä»¥äº¤æ¢è¯­è¨€
    document.getElementById('from-language').addEventListener('dblclick', swapLanguages);
    document.getElementById('to-language').addEventListener('dblclick', swapLanguages);
    
    // å¤„ç†æŒ‰é’®
    document.getElementById('process-btn').addEventListener('click', processContent);
    
    // å·¥å…·æŒ‰é’®
    document.getElementById('clear-input').addEventListener('click', clearInput);
    document.getElementById('paste-text').addEventListener('click', pasteText);
    document.getElementById('copy-result').addEventListener('click', copyResult);
    document.getElementById('clear-input-btn').addEventListener('click', clearInput);
    document.getElementById('clear-result-btn').addEventListener('click', clearResult);
    
    // å›¾ç‰‡ä¸Šä¼ 
    document.getElementById('image-upload').addEventListener('change', handleImageUpload);
    
    // æ–‡æ¡£ä¸Šä¼ 
    document.getElementById('document-upload').addEventListener('change', handleDocumentUpload);
    
    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
        // Ctrl+Shift+S å¿«é€Ÿäº¤æ¢è¯­è¨€
        if (e.ctrlKey && e.shiftKey && e.key === 'S') {
            e.preventDefault();
            swapLanguages();
        }
    });
}

// äº¤æ¢æºè¯­è¨€å’Œç›®æ ‡è¯­è¨€
function swapLanguages() {
    const fromSelect = document.getElementById('from-language');
    const toSelect = document.getElementById('to-language');
    
    // è·å–å½“å‰é€‰ä¸­çš„å€¼
    const fromValue = fromSelect.value;
    const toValue = toSelect.value;
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥äº¤æ¢ï¼ˆautoä¸èƒ½ä½œä¸ºç›®æ ‡è¯­è¨€ï¼‰
    if (fromValue === 'auto') {
        showToast('è‡ªåŠ¨æ£€æµ‹è¯­è¨€ä¸èƒ½ä½œä¸ºç›®æ ‡è¯­è¨€', 'warning');
        return;
    }
    
    if (fromValue === toValue) {
        showToast('æºè¯­è¨€å’Œç›®æ ‡è¯­è¨€ç›¸åŒï¼Œæ— éœ€äº¤æ¢', 'info');
        return;
    }
    
    // æ‰§è¡Œäº¤æ¢
    fromSelect.value = toValue;
    toSelect.value = fromValue;
    
    // æ·»åŠ è§†è§‰åé¦ˆåŠ¨ç”»
    const swapButton = document.getElementById('swap-languages');
    swapButton.style.transform = 'rotate(180deg)';
    swapButton.style.transition = 'transform 0.3s ease';
    
    setTimeout(() => {
        swapButton.style.transform = 'rotate(0deg)';
    }, 300);
    
    // æ˜¾ç¤ºæˆåŠŸæç¤º
    const fromLanguageName = fromSelect.options[fromSelect.selectedIndex].text;
    const toLanguageName = toSelect.options[toSelect.selectedIndex].text;
    
    showToast(`å·²äº¤æ¢è¯­è¨€ï¼š${toLanguageName} â†” ${fromLanguageName}`, 'success');
    
    console.log('ğŸ”„ è¯­è¨€äº¤æ¢å®Œæˆ:', {
        ä»: toLanguageName + ' (' + toValue + ')',
        åˆ°: fromLanguageName + ' (' + fromValue + ')'
    });
}

// åˆ‡æ¢åŠŸèƒ½æ¨¡å¼
function switchMode(mode) {
    currentMode = mode;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('[data-mode]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
    
    // æ›´æ–°ç•Œé¢æ˜¾ç¤º
    updateModeDisplay();
    updateProviderByCurrentMode();
}

// æ›´æ–°æ¨¡å¼æ˜¾ç¤º
function updateModeDisplay() {
    const languageControls = document.getElementById('language-controls');
    const imageUploadArea = document.getElementById('image-upload-area');
    const documentUploadArea = document.getElementById('document-upload-area');
    const textInputArea = document.getElementById('text-input-area');
    const domainSelection = document.getElementById('domain-selection');
    const processBtn = document.getElementById('process-btn');
    const fileUploadBtn = document.getElementById('file-upload');
    
    // é‡ç½®æ˜¾ç¤º
    languageControls.classList.remove('d-none');
    imageUploadArea.classList.add('d-none');
    documentUploadArea.classList.add('d-none');
    textInputArea.classList.remove('d-none');
    domainSelection.classList.add('d-none');
    fileUploadBtn.classList.remove('d-none');
    
    const modeConfig = {
        'translate': {
            title: 'å¼€å§‹ç¿»è¯‘',
            icon: 'fas fa-language',
            placeholder: 'è¾“å…¥éœ€è¦ç¿»è¯‘çš„æ–‡æœ¬å†…å®¹...',
            showLanguages: true,
            hideFileUpload: true
        },
        'document_translate': {
            title: 'æ–‡æ¡£ç¿»è¯‘',
            icon: 'fas fa-file-alt',
            placeholder: 'ä¸Šä¼ æ–‡æ¡£è¿›è¡Œç¿»è¯‘...',
            showLanguages: true,
            showDocumentUpload: true
        },
        'image_translate': {
            title: 'å›¾ç‰‡ç¿»è¯‘',
            icon: 'fas fa-image',
            placeholder: 'ä¸Šä¼ åŒ…å«æ–‡å­—çš„å›¾ç‰‡è¿›è¡Œè¯†åˆ«ç¿»è¯‘...',
            showLanguages: true,
            showImageUpload: true
        },
        'domain_translate': {
            title: 'é¢†åŸŸç¿»è¯‘',
            icon: 'fas fa-graduation-cap',
            placeholder: 'è¾“å…¥ä¸“ä¸šé¢†åŸŸæ–‡æœ¬è¿›è¡Œç¿»è¯‘...',
            showLanguages: true,
            showDomainSelection: true
        },
        'ai_translate': {
            title: 'AIç¿»è¯‘',
            icon: 'fas fa-brain',
            placeholder: 'è¾“å…¥æ–‡æœ¬ï¼ŒAIå°†æä¾›æ™ºèƒ½ç¿»è¯‘...',
            showLanguages: true
        },
        'grammar_check': {
            title: 'è¯­æ³•æ£€æŸ¥',
            icon: 'fas fa-spell-check',
            placeholder: 'è¾“å…¥æ–‡æœ¬è¿›è¡Œè¯­æ³•æ£€æŸ¥å’Œçº é”™...',
            showLanguages: false
        },
        'summary': {
            title: 'æ™ºèƒ½æ€»ç»“',
            icon: 'fas fa-compress-alt',
            placeholder: 'è¾“å…¥é•¿æ–‡æœ¬è¿›è¡Œæ™ºèƒ½æ€»ç»“...',
            showLanguages: false
        },
        'rewrite': {
            title: 'æ–‡æ®µæ”¹å†™',
            icon: 'fas fa-edit',
            placeholder: 'è¾“å…¥æ–‡æœ¬è¿›è¡Œæ”¹å†™ä¼˜åŒ–...',
            showLanguages: false
        }
    };
    
    const config = modeConfig[currentMode];
    if (config) {
        // æ›´æ–°å¤„ç†æŒ‰é’®
        processBtn.innerHTML = `<i class="${config.icon} me-2"></i>${config.title}`;
        
        // æ›´æ–°è¾“å…¥æ¡†placeholder
        document.getElementById('input-text').placeholder = config.placeholder;
        
        // æ§åˆ¶è¯­è¨€é€‰æ‹©æ˜¾ç¤º
        if (!config.showLanguages) {
            languageControls.classList.add('d-none');
        }
        
        // æ§åˆ¶å›¾ç‰‡ä¸Šä¼ æ˜¾ç¤º
        if (config.showImageUpload) {
            imageUploadArea.classList.remove('d-none');
            textInputArea.classList.add('d-none');
        }
        
        // æ§åˆ¶æ–‡æ¡£ä¸Šä¼ æ˜¾ç¤º
        if (config.showDocumentUpload) {
            documentUploadArea.classList.remove('d-none');
            textInputArea.classList.add('d-none');
        }
        
        // æ§åˆ¶é¢†åŸŸé€‰æ‹©æ˜¾ç¤º
        if (config.showDomainSelection) {
            domainSelection.classList.remove('d-none');
        }
        
        // æ§åˆ¶ä¸Šä¼ æ–‡ä»¶æŒ‰é’®æ˜¾ç¤º
        if (config.hideFileUpload) {
            fileUploadBtn.classList.add('d-none');
        }
    }
}

// æ ¹æ®å½“å‰æ¨¡å¼æ›´æ–°æœåŠ¡æä¾›å•†æ˜¾ç¤º
function updateProviderByCurrentMode() {
    const statusElement = document.getElementById('provider-status');
    if (!statusElement) return;
    
    switch(currentMode) {
        case 'translate':
        case 'image_translate':
        case 'document_translate':
        case 'domain_translate':
            statusElement.innerHTML = '<i class="fas fa-globe me-1"></i>ç™¾åº¦ç¿»è¯‘';
            statusElement.className = 'badge bg-primary';
            statusElement.title = 'ç™¾åº¦ç¿»è¯‘APIæœåŠ¡ - ä¸“ä¸šç¿»è¯‘å¼•æ“';
            break;
            
        case 'ai_translate':
            statusElement.innerHTML = '<i class="fas fa-brain me-1"></i>DeepSeek AI';
            statusElement.className = 'badge bg-info';
            statusElement.title = 'DeepSeekæ™ºèƒ½ç¿»è¯‘ - é€šè¿‡Difyè°ƒç”¨';
            break;
            
        default:
            statusElement.innerHTML = '<i class="fas fa-robot me-1"></i>AIæ™ºèƒ½å¤„ç†';
            statusElement.className = 'badge bg-success';
            statusElement.title = 'AIæ™ºèƒ½å¤„ç†æœåŠ¡ - è¯­æ³•æ£€æŸ¥ã€æ€»ç»“ã€æ”¹å†™';
    }
}

// å…¶ä»–åŠŸèƒ½å‡½æ•°...
function updateCharCount() {
    const text = document.getElementById('input-text').value;
    const count = text.length;
    const counter = document.getElementById('char-count');
    
    counter.textContent = count;
    
    if (count > 4500) {
        counter.className = 'text-danger fw-bold';
    } else if (count > 3000) {
        counter.className = 'text-warning fw-bold';
    } else {
        counter.className = 'text-muted';
    }
}

function swapLanguages() {
    const fromLang = document.getElementById('from-language');
    const toLang = document.getElementById('to-language');
    
    if (fromLang.value !== 'auto') {
        const temp = fromLang.value;
        fromLang.value = toLang.value;
        toLang.value = temp;
    }
}

function clearInput() {
    document.getElementById('input-text').value = '';
    updateCharCount();
    document.getElementById('result-placeholder').classList.remove('d-none');
    document.getElementById('result-content').classList.add('d-none');
    document.getElementById('copy-result').classList.add('d-none');
    document.getElementById('download-result').classList.add('d-none');
    document.getElementById('clear-result-btn').classList.add('d-none');
    document.getElementById('result-stats').style.display = 'none';
}

function clearResult() {
    document.getElementById('result-placeholder').classList.remove('d-none');
    document.getElementById('result-content').classList.add('d-none');
    document.getElementById('copy-result').classList.add('d-none');
    document.getElementById('download-result').classList.add('d-none');
    document.getElementById('clear-result-btn').classList.add('d-none');
    document.getElementById('result-stats').style.display = 'none';
    
    // æ¸…ç©ºç»“æœæ–‡æœ¬
    const resultText = document.querySelector('#result-content .result-text');
    if (resultText) {
        resultText.textContent = '';
    }
    
    showToast('ç»“æœå·²æ¸…ç©º', 'success');
}

function setQuickText(text) {
    document.getElementById('input-text').value = text;
    updateCharCount();
}

async function pasteText() {
    try {
        const text = await navigator.clipboard.readText();
        document.getElementById('input-text').value = text;
        updateCharCount();
        showToast('æ–‡æœ¬å·²ç²˜è´´', 'success');
    } catch (err) {
        showToast('ç²˜è´´å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´', 'warning');
    }
}

async function copyResult() {
    const resultText = document.querySelector('#result-content .result-text').textContent;
    try {
        await navigator.clipboard.writeText(resultText);
        showToast('ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    } catch (err) {
        showToast('å¤åˆ¶å¤±è´¥', 'error');
    }
}

function handleImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
        if (file.size > 10 * 1024 * 1024) {
            showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('image-preview');
            const img = preview.querySelector('img');
            img.src = e.target.result;
            preview.classList.remove('d-none');
        };
        reader.readAsDataURL(file);
    }
}

function removeImage() {
    document.getElementById('image-upload').value = '';
    document.getElementById('image-preview').classList.add('d-none');
}

function handleDocumentUpload(event) {
    const file = event.target.files[0];
    if (file) {
        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ50MBé™åˆ¶ï¼‰
        if (file.size > 50 * 1024 * 1024) {
            showToast('æ–‡æ¡£å¤§å°ä¸èƒ½è¶…è¿‡50MB', 'error');
            return;
        }
        
        // æ£€æŸ¥æ–‡ä»¶æ ¼å¼
        const allowedTypes = ['doc', 'docx', 'pdf', 'txt', 'html', 'htm', 'xls', 'xlsx', 'ppt', 'pptx', 'xml'];
        const fileExt = file.name.split('.').pop().toLowerCase();
        if (!allowedTypes.includes(fileExt)) {
            showToast('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼', 'error');
            return;
        }
        
        // æ˜¾ç¤ºæ–‡æ¡£é¢„è§ˆ
        const preview = document.getElementById('document-preview');
        const nameElement = document.getElementById('document-name');
        const sizeElement = document.getElementById('document-size');
        
        nameElement.textContent = file.name;
        sizeElement.textContent = `æ–‡ä»¶å¤§å°: ${formatFileSize(file.size)}`;
        
        preview.classList.remove('d-none');
        
        // æ›´æ–°ä¸Šä¼ çŠ¶æ€
        document.getElementById('upload-status').textContent = 'å‡†å¤‡ç¿»è¯‘...';
        document.getElementById('upload-progress').style.width = '0%';
    }
}

function removeDocument() {
    document.getElementById('document-upload').value = '';
    document.getElementById('document-preview').classList.add('d-none');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// å¤„ç†å†…å®¹
async function processContent() {
    if (isProcessing) return;
    
    const content = document.getElementById('input-text').value.trim();
    
    // éªŒè¯è¾“å…¥
    if (currentMode === 'image_translate') {
        const imageInput = document.getElementById('image-upload');
        if (!imageInput.files[0]) {
            showToast('è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 'warning');
            return;
        }
    } else if (currentMode === 'document_translate') {
        const documentInput = document.getElementById('document-upload');
        if (!documentInput.files[0]) {
            showToast('è¯·å…ˆä¸Šä¼ æ–‡æ¡£', 'warning');
            return;
        }
    } else {
        if (!content) {
            showToast('è¯·è¾“å…¥è¦å¤„ç†çš„å†…å®¹', 'warning');
            return;
        }
    }
    
    isProcessing = true;
    startTime = Date.now();
    
    showProcessingState(true);
    updateProcessButton(true);
    
    try {
        await sendProcessRequest(content);
    } catch (error) {
        console.error('å¤„ç†å¤±è´¥:', error);
        showToast(error.message || 'å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    } finally {
        isProcessing = false;
        showProcessingState(false);
        updateProcessButton(false);
    }
}

async function sendProcessRequest(content) {
    let requestType = currentMode;
    // æ–‡æœ¬ç¿»è¯‘ä½¿ç”¨ç™¾åº¦APIï¼Œä¸éœ€è¦ä¿®æ”¹requestType
    // AIç¿»è¯‘ä½¿ç”¨Dify APIï¼Œå‰ç«¯æ¨¡å¼æ˜¯ai_translateï¼Œåç«¯æœŸæœ›api_translate
    if (currentMode === 'ai_translate') requestType = 'api_translate';
    if (currentMode === 'domain_translate') requestType = 'domain_translate';
    
    let response;
    
    if (currentMode === 'document_translate') {
        // æ–‡æ¡£ç¿»è¯‘ä½¿ç”¨ä¸“é—¨çš„API
        const documentInput = document.getElementById('document-upload');
        if (!documentInput.files[0]) {
            throw new Error('è¯·å…ˆä¸Šä¼ æ–‡æ¡£');
        }
        
        const formData = new FormData();
        formData.append('file', documentInput.files[0]);
        formData.append('from_lang', document.getElementById('from-language').value);
        formData.append('to_lang', document.getElementById('to-language').value);
        
        // æ›´æ–°ä¸Šä¼ çŠ¶æ€
        document.getElementById('upload-status').textContent = 'æ­£åœ¨ä¸Šä¼ ç¿»è¯‘...';
        document.getElementById('upload-progress').style.width = '50%';
        
        response = await fetch('/api/translation/document/upload', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) throw new Error('æ–‡æ¡£ä¸Šä¼ å¤±è´¥');
        
        const result = await response.json();
        if (result.success) {
            document.getElementById('upload-status').textContent = 'ç¿»è¯‘ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†...';
            document.getElementById('upload-progress').style.width = '100%';
            
            // æ˜¾ç¤ºç»“æœ
            showResult(`æ–‡æ¡£ç¿»è¯‘ä»»åŠ¡å·²æäº¤æˆåŠŸï¼\n\nä»»åŠ¡ID: ${result.request_id}\n\n${result.message}\n\nè¯·ç¨åæŸ¥è¯¢ç¿»è¯‘è¿›åº¦ã€‚`);
            return;
        } else {
            throw new Error(result.error || 'æ–‡æ¡£ç¿»è¯‘å¤±è´¥');
        }
    } else if (currentMode === 'image_translate') {
        // å›¾ç‰‡ç¿»è¯‘ä½¿ç”¨FormData
        const imageInput = document.getElementById('image-upload');
        if (!imageInput.files[0]) {
            throw new Error('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
        }
        
        const formData = new FormData();
        formData.append('type', requestType);
        formData.append('image', imageInput.files[0]);
        formData.append('from_lang', document.getElementById('from-language').value);
        formData.append('to_lang', document.getElementById('to-language').value);
        if (currentMode === 'domain_translate') {
            formData.append('domain', document.getElementById('translation-domain').value);
        }
        
        response = await fetch('/api/document/process', {
            method: 'POST',
            body: formData
        });
    } else {
        // å…¶ä»–ç±»å‹ä½¿ç”¨JSON
        const requestData = {
            type: requestType,
            content: content,
            from_lang: document.getElementById('from-language').value,
            to_lang: document.getElementById('to-language').value
        };
        
        // åªåœ¨é¢†åŸŸç¿»è¯‘æ—¶æ·»åŠ domainå‚æ•°
        if (currentMode === 'domain_translate') {
            requestData.domain = document.getElementById('translation-domain').value;
        }
        
        response = await fetch('/api/document/process', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        });
    }
    
    if (!response.ok) throw new Error('è¯·æ±‚å¤±è´¥');
    
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let resultText = '';
    
    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop() || '';
        
        for (const line of lines) {
            if (line.startsWith('data: ')) {
                try {
                    const data = JSON.parse(line.slice(6));
                    
                    if (data.type === 'end') {
                        showResult(resultText);
                        return;
                    } else if (data.type === 'image_translation_result' && data.content) {
                        // å¤„ç†å›¾ç‰‡ç¿»è¯‘ç»“æœ
                        if (data.content.success) {
                            const translatedTexts = data.content.translated_texts || [];
                            const originalTexts = data.content.original_texts || [];
                            
                            let displayText = '';
                            if (translatedTexts.length > 0) {
                                displayText = 'å›¾ç‰‡ç¿»è¯‘ç»“æœï¼š\n\n';
                                for (let i = 0; i < Math.max(originalTexts.length, translatedTexts.length); i++) {
                                    if (originalTexts[i] && translatedTexts[i]) {
                                        displayText += `åŸæ–‡ï¼š${originalTexts[i]}\n`;
                                        displayText += `è¯‘æ–‡ï¼š${translatedTexts[i]}\n\n`;
                                    }
                                }
                            } else {
                                displayText = 'æœªèƒ½è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—å†…å®¹';
                            }
                            resultText = displayText;
                            updateResult(resultText);
                        } else {
                            throw new Error(data.content.error || 'å›¾ç‰‡ç¿»è¯‘å¤±è´¥');
                        }
                    } else if (data.content) {
                        resultText += data.content;
                        updateResult(resultText);
                    } else if (data.error) {
                        throw new Error(data.error);
                    }
                } catch (e) {
                    if (e.message !== 'Unexpected end of JSON input') {
                        console.error('è§£æå“åº”å¤±è´¥:', e);
                    }
                }
            }
        }
    }
}

function showProcessingState(show) {
    const placeholder = document.getElementById('result-placeholder');
    const loading = document.getElementById('loading-state');
    const content = document.getElementById('result-content');
    
    if (show) {
        placeholder.classList.add('d-none');
        loading.classList.remove('d-none');
        content.classList.add('d-none');
    } else {
        loading.classList.add('d-none');
    }
}

function updateResult(text) {
    const resultContent = document.getElementById('result-content');
    const resultText = resultContent.querySelector('.result-text');
    
    resultText.textContent = text;
    
    if (resultContent.classList.contains('d-none')) {
        document.getElementById('result-placeholder').classList.add('d-none');
        document.getElementById('loading-state').classList.add('d-none');
        resultContent.classList.remove('d-none');
        
        document.getElementById('copy-result').classList.remove('d-none');
        document.getElementById('download-result').classList.remove('d-none');
        document.getElementById('clear-result-btn').classList.remove('d-none');
    }
}

function showResult(text) {
    updateResult(text);
    
    const processTime = ((Date.now() - startTime) / 1000).toFixed(1) + 's';
    const charCount = text.length;
    const serviceUsed = getServiceName();
    
    document.getElementById('process-time').textContent = processTime;
    document.getElementById('result-chars').textContent = charCount;
    document.getElementById('service-used').textContent = serviceUsed;
    
    // æ˜¾ç¤ºç»“æœç»Ÿè®¡åŒºåŸŸ
    document.getElementById('result-stats').style.display = 'block';
}

function getServiceName() {
    const statusElement = document.getElementById('provider-status');
    return statusElement.textContent.trim();
}

function updateProcessButton(processing) {
    const btn = document.getElementById('process-btn');
    
    if (processing) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>å¤„ç†ä¸­...';
    } else {
        btn.disabled = false;
        updateModeDisplay();
    }
}

async function loadTranslationConfig() {
    try {
        const languagesResponse = await fetch('/api/translation/languages');
        if (languagesResponse.ok) {
            const languagesData = await languagesResponse.json();
            populateLanguageSelects(languagesData.languages);
        }
        

        
        updateProviderByCurrentMode();
        
    } catch (error) {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
    }
}

function populateLanguageSelects(languages) {
    const fromSelect = document.getElementById('from-language');
    const toSelect = document.getElementById('to-language');
    
    fromSelect.innerHTML = '<option value="auto">è‡ªåŠ¨æ£€æµ‹è¯­è¨€</option>';
    toSelect.innerHTML = '';
    
    Object.entries(languages).forEach(([code, name]) => {
        if (code !== 'auto') {
            const toOption = document.createElement('option');
            toOption.value = code;
            toOption.textContent = name;
            if (code === 'zh') toOption.selected = true;
            toSelect.appendChild(toOption);
            
            const fromOption = document.createElement('option');
            fromOption.value = code;
            fromOption.textContent = name;
            fromSelect.appendChild(fromOption);
        }
    });
}



function showToast(message, type = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';
    
    const toast = document.createElement('div');
    toast.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2);';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${message}
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}
</script>
{% endblock %}
