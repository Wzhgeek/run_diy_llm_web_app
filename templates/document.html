{% extends "base.html" %}

{% block title %}文档处理 - Dify智能助手{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-file-alt me-2"></i>文档处理
                            </h5>
                        </div>
                        <div class="col-md-4">
                            <div class="text-end">
                                <small class="text-muted">翻译服务：</small>
                                <span class="badge bg-success ms-1" id="provider-status">
                                    <i class="fas fa-robot me-1"></i>DIFY AI
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 功能选择标签页 -->
                    <ul class="nav nav-tabs mb-4" id="taskTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="translate-tab" data-bs-toggle="tab" data-bs-target="#translate" type="button" role="tab">
                                <i class="fas fa-language me-2"></i>通用翻译
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="domain_translate-tab" data-bs-toggle="tab" data-bs-target="#domain_translate" type="button" role="tab">
                                <i class="fas fa-industry me-2"></i>领域翻译
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="image_translate-tab" data-bs-toggle="tab" data-bs-target="#image_translate" type="button" role="tab">
                                <i class="fas fa-image me-2"></i>图片翻译
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="api_translate-tab" data-bs-toggle="tab" data-bs-target="#api_translate" type="button" role="tab">
                                <i class="fas fa-robot me-2"></i>AI翻译
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="grammar_check-tab" data-bs-toggle="tab" data-bs-target="#grammar_check" type="button" role="tab">
                                <i class="fas fa-spell-check me-2"></i>语法检查
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">
                                <i class="fas fa-compress-alt me-2"></i>总结
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="rewrite-tab" data-bs-toggle="tab" data-bs-target="#rewrite" type="button" role="tab">
                                <i class="fas fa-edit me-2"></i>改写
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="complete-tab" data-bs-toggle="tab" data-bs-target="#complete" type="button" role="tab">
                                <i class="fas fa-magic me-2"></i>完整处理
                            </button>
                        </li>
                    </ul>

                    <div class="row">
                        <!-- 输入区域 -->
                        <div class="col-lg-6">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-upload me-2"></i>输入内容
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- 文本输入区域 -->
                                    <div class="mb-3">
                                        <label for="input-text" class="form-label">输入文本内容</label>
                                        <textarea class="form-control" id="input-text" 
                                                 rows="15" 
                                                 placeholder="请输入需要处理的文本内容..."
                                                 style="resize: vertical;"></textarea>
                                        <div class="form-text">
                                            <span id="char-count">0</span> 字符
                                        </div>
                                    </div>

                                    <!-- 选项配置 -->
                                    <div class="tab-content" id="optionsContent">
                                        <!-- 翻译选项 -->
                                        <div class="tab-pane fade show active" id="translate" role="tabpanel">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="form-label">源语言</label>
                                                    <select class="form-select" id="from-language">
                                                        <option value="auto" selected>自动检测</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">目标语言</label>
                                                    <select class="form-select" id="to-language">
                                                        <option value="zh" selected>中文（简体）</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-md-12">
                                                    <label class="form-label">翻译场景</label>
                                                    <select class="form-select" id="translation-scenario">
                                                        <option value="general" selected>通用文本</option>
                                                    </select>
                                                    <div class="form-text" id="scenario-description">适用于一般性文本的翻译</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 领域翻译选项 -->
                                        <div class="tab-pane fade" id="domain_translate" role="tabpanel">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="form-label">源语言</label>
                                                    <select class="form-select" id="domain-from-language">
                                                        <option value="auto" selected>自动检测</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">目标语言</label>
                                                    <select class="form-select" id="domain-to-language">
                                                        <option value="zh" selected>中文（简体）</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-md-12">
                                                    <label class="form-label">专业领域</label>
                                                    <select class="form-select" id="translation-domain">
                                                        <option value="it">信息技术</option>
                                                        <option value="finance">金融财经</option>
                                                        <option value="medicine">生物医药</option>
                                                        <option value="mechanics">机械制造</option>
                                                        <option value="senimed">法律政府</option>
                                                        <option value="novel">影视文学</option>
                                                        <option value="academic" selected>学术论文</option>
                                                        <option value="aerospace">航空航天</option>
                                                        <option value="wiki">人文社科</option>
                                                        <option value="news">新闻资讯</option>
                                                        <option value="contract">合同文档</option>
                                                    </select>
                                                    <div class="form-text">选择专业领域可获得更准确的术语翻译</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 图片翻译选项 -->
                                        <div class="tab-pane fade" id="image_translate" role="tabpanel">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="form-label">源语言</label>
                                                    <select class="form-select" id="image-from-language">
                                                        <option value="auto" selected>自动检测</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">目标语言</label>
                                                    <select class="form-select" id="image-to-language">
                                                        <option value="zh" selected>中文（简体）</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-md-12">
                                                    <label class="form-label">上传图片</label>
                                                    <input type="file" class="form-control" id="image-upload" accept=".jpg,.jpeg,.png,.bmp">
                                                    <div class="form-text">支持JPG、PNG、BMP格式，最大4MB</div>
                                                </div>
                                            </div>
                                            <div class="row mt-3" id="image-preview-container" style="display: none;">
                                                <div class="col-md-12">
                                                    <label class="form-label">图片预览</label>
                                                    <div class="border rounded p-2">
                                                        <img id="image-preview" class="img-fluid" style="max-height: 300px;">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- AI翻译选项 -->
                                        <div class="tab-pane fade" id="api_translate" role="tabpanel">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="form-label">源语言</label>
                                                    <select class="form-select" id="api-from-language">
                                                        <option value="auto" selected>自动检测</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">目标语言</label>
                                                    <select class="form-select" id="api-to-language">
                                                        <option value="zh" selected>中文（简体）</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-md-12">
                                                    <div class="alert alert-success">
                                                        <i class="fas fa-robot me-2"></i>
                                                        <strong>AI智能翻译：</strong> 使用Dify大模型进行翻译，提供更自然、准确的翻译结果
                                                        <br><small>适用于复杂语境、创意文本和需要理解上下文的内容翻译</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 语法检查选项 -->
                                        <div class="tab-pane fade" id="grammar_check" role="tabpanel">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="alert alert-info">
                                                        <i class="fas fa-info-circle me-2"></i>
                                                        语法检查功能将分析文本中的标点符号、括号匹配等问题，并给出改进建议。
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 总结选项 -->
                                        <div class="tab-pane fade" id="summary" role="tabpanel">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <label class="form-label">总结类型</label>
                                                    <select class="form-select" id="summary-type">
                                                        <option value="要点">要点提取</option>
                                                        <option value="摘要" selected>内容摘要</option>
                                                        <option value="大纲">结构大纲</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 改写选项 -->
                                        <div class="tab-pane fade" id="rewrite" role="tabpanel">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <label class="form-label">改写风格</label>
                                                    <select class="form-select" id="rewrite-style">
                                                        <option value="formal" selected>正式文体</option>
                                                        <option value="casual">通俗易懂</option>
                                                        <option value="academic">学术风格</option>
                                                        <option value="business">商务风格</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 完整处理选项 -->
                                        <div class="tab-pane fade" id="complete" role="tabpanel">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="form-label">源语言</label>
                                                    <select class="form-select" id="complete-from-language">
                                                        <option value="auto" selected>自动检测</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">目标语言</label>
                                                    <select class="form-select" id="complete-to-language">
                                                        <option value="zh" selected>中文（简体）</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">翻译场景</label>
                                                    <select class="form-select" id="complete-scenario">
                                                        <option value="general" selected>通用文本</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">改写风格</label>
                                                    <select class="form-select" id="complete-style">
                                                        <option value="formal" selected>正式文体</option>
                                                        <option value="casual">通俗易懂</option>
                                                        <option value="academic">学术风格</option>
                                                        <option value="business">商务风格</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-md-12">
                                                    <div class="alert alert-success">
                                                        <i class="fas fa-magic me-2"></i>
                                                        <strong>完整处理流程：</strong> 翻译 → 语法检查 → 总结 → 改写优化
                                                        <br><small>将按顺序执行所有处理步骤，为您提供最完整的文档处理服务。</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 处理按钮 -->
                                    <div class="d-grid gap-2 mt-4">
                                        <button class="btn btn-primary" id="process-btn" onclick="processDocument()">
                                            <i class="fas fa-cogs me-2"></i>开始处理
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="clearInput()">
                                            <i class="fas fa-eraser me-2"></i>清空内容
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 输出区域 -->
                        <div class="col-lg-6">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-download me-2"></i>处理结果
                                        </h6>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-light btn-sm" onclick="copyResult()" title="复制结果">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="output-area" class="h-100">
                                        <div class="text-center text-muted py-5" id="placeholder">
                                            <i class="fas fa-magic fa-3x mb-3"></i>
                                            <h5>等待处理</h5>
                                            <p>请在左侧输入内容并选择处理类型</p>
                                        </div>
                                        
                                        <!-- 处理中状态 -->
                                        <div id="processing" class="text-center py-5 d-none">
                                            <div class="spinner-border text-primary mb-3" role="status">
                                                <span class="visually-hidden">处理中...</span>
                                            </div>
                                            <h5>正在处理中</h5>
                                            <p class="text-muted">请稍候，AI正在分析和处理您的内容...</p>
                                        </div>

                                        <!-- 结果显示区域 -->
                                        <div id="result-content" class="d-none">
                                            <div class="border rounded p-3 bg-light" 
                                                 style="min-height: 400px; white-space: pre-wrap; font-family: inherit;">
                                                <div id="result-text"></div>
                                            </div>
                                            
                                            <!-- 结果统计 -->
                                            <div class="mt-3">
                                                <div class="row text-center">
                                                    <div class="col-6">
                                                        <div class="border-end">
                                                            <div class="fw-bold text-primary" id="result-chars">0</div>
                                                            <small class="text-muted">字符数</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="fw-bold text-info" id="task-type">翻译</div>
                                                        <small class="text-muted">处理类型</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}



{% block extra_js %}
<script>
    let isProcessing = false;
    let startTime = 0;

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 绑定字符计数
        document.getElementById('input-text').addEventListener('input', updateCharCount);
        
        // 绑定标签页切换事件
        document.querySelectorAll('#taskTabs button').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(e) {
                updateTaskTypeDisplay();
            });
        });

        // 绑定翻译场景变化事件
        document.getElementById('translation-scenario').addEventListener('change', updateScenarioDescription);
        document.getElementById('complete-scenario').addEventListener('change', updateCompleteScenarioDescription);
        
        // 绑定图片上传事件
        document.getElementById('image-upload').addEventListener('change', handleImageUpload);

        updateCharCount();
        updateTaskTypeDisplay();
        
        // 加载翻译配置数据
        loadTranslationConfig();
    });

    // 更新字符计数
    function updateCharCount() {
        const text = document.getElementById('input-text').value;
        document.getElementById('char-count').textContent = text.length;
    }

    // 更新任务类型显示
    function updateTaskTypeDisplay() {
        const activeTab = document.querySelector('#taskTabs .nav-link.active');
        const taskType = activeTab.textContent.trim();
        document.getElementById('task-type').textContent = taskType;
    }

    // 加载翻译配置数据
    async function loadTranslationConfig() {
        try {
            // 加载支持的语言
            const languagesResponse = await fetch('/api/translation/languages');
            if (languagesResponse.ok) {
                const languagesData = await languagesResponse.json();
                populateLanguageSelects(languagesData.languages);
            }

            // 加载翻译场景
            const scenariosResponse = await fetch('/api/translation/scenarios');
            if (scenariosResponse.ok) {
                const scenariosData = await scenariosResponse.json();
                populateScenarioSelects(scenariosData.scenarios);
            }

            // 加载翻译提供商状态
            const providerResponse = await fetch('/api/translation/provider');
            if (providerResponse.ok) {
                const providerData = await providerResponse.json();
                updateProviderStatus(providerData.provider);
            }
        } catch (error) {
            console.error('加载翻译配置失败:', error);
            showToast('加载翻译配置失败', 'warning');
        }
    }

    // 更新翻译提供商状态显示
    function updateProviderStatus(provider) {
        const statusElement = document.getElementById('provider-status');
        if (!statusElement) return;
        
        if (provider.current_provider === 'dify') {
            statusElement.innerHTML = '<i class="fas fa-robot me-1"></i>DIFY AI';
            statusElement.className = 'badge bg-success ms-1';
        } else if (provider.current_provider === 'baidu') {
            statusElement.innerHTML = '<i class="fas fa-globe me-1"></i>百度翻译';
            statusElement.className = 'badge bg-primary ms-1';
        }
        
        statusElement.title = provider.note || '智能翻译服务';
    }

    // 填充语言选择器
    function populateLanguageSelects(languages) {
        const selects = [
            'from-language', 
            'to-language', 
            'domain-from-language',
            'domain-to-language',
            'image-from-language',
            'image-to-language',
            'api-from-language',
            'api-to-language',
            'complete-from-language', 
            'complete-to-language'
        ];

        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // 清空现有选项（除了默认选项）
            select.innerHTML = '';
            
            // 添加语言选项
            Object.entries(languages).forEach(([code, name]) => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = name;
                
                // 保持之前的选择或设置默认值
                if (code === currentValue || 
                    (selectId.includes('from') && code === 'auto') ||
                    (selectId.includes('to') && code === 'zh')) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            });
        });
    }

    // 填充场景选择器
    function populateScenarioSelects(scenarios) {
        const selects = ['translation-scenario', 'complete-scenario'];

        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // 清空现有选项
            select.innerHTML = '';
            
            // 添加场景选项
            Object.entries(scenarios).forEach(([key, scenario]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = scenario.name;
                option.setAttribute('data-description', scenario.description);
                
                // 保持之前的选择或设置默认值
                if (key === currentValue || key === 'general') {
                    option.selected = true;
                }
                
                select.appendChild(option);
            });
        });

        // 更新场景描述
        updateScenarioDescription();
        updateCompleteScenarioDescription();
    }

    // 更新翻译场景描述
    function updateScenarioDescription() {
        const select = document.getElementById('translation-scenario');
        const selectedOption = select.options[select.selectedIndex];
        const description = selectedOption.getAttribute('data-description') || '';
        document.getElementById('scenario-description').textContent = description;
    }

    // 更新完整处理场景描述
    function updateCompleteScenarioDescription() {
        const select = document.getElementById('complete-scenario');
        const selectedOption = select.options[select.selectedIndex];
        // 这里可以添加完整处理场景描述的更新逻辑
    }

    // 处理图片上传
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            // 检查文件大小（4MB限制）
            if (file.size > 4 * 1024 * 1024) {
                showToast('图片大小不能超过4MB', 'error');
                event.target.value = '';
                return;
            }
            
            // 检查文件类型
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/bmp'];
            if (!allowedTypes.includes(file.type)) {
                showToast('请选择JPG、PNG或BMP格式的图片', 'error');
                event.target.value = '';
                return;
            }
            
            // 显示图片预览
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('image-preview-container').style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            // 隐藏预览
            document.getElementById('image-preview-container').style.display = 'none';
        }
    }

    // 处理文档
    async function processDocument() {
        if (isProcessing) {
            showToast('正在处理中，请稍候...', 'warning');
            return;
        }

        const content = document.getElementById('input-text').value.trim();
        if (!content) {
            showToast('请输入要处理的内容', 'warning');
            return;
        }

        // 获取当前任务类型
        const activeTab = document.querySelector('#taskTabs .nav-link.active');
        const taskType = activeTab.id.replace('-tab', '');

        // 获取配置参数
        let config = {};
        if (taskType === 'translate') {
            config.from_lang = document.getElementById('from-language').value;
            config.to_lang = document.getElementById('to-language').value;
            config.scenario = document.getElementById('translation-scenario').value;
        } else if (taskType === 'domain_translate') {
            config.from_lang = document.getElementById('domain-from-language').value;
            config.to_lang = document.getElementById('domain-to-language').value;
            config.domain = document.getElementById('translation-domain').value;
        } else if (taskType === 'image_translate') {
            const imageFile = document.getElementById('image-upload').files[0];
            if (!imageFile) {
                showToast('请先上传图片', 'warning');
                return;
            }
            config.from_lang = document.getElementById('image-from-language').value;
            config.to_lang = document.getElementById('image-to-language').value;
            config.image_file = imageFile;
        } else if (taskType === 'api_translate') {
            config.from_lang = document.getElementById('api-from-language').value;
            config.to_lang = document.getElementById('api-to-language').value;
        } else if (taskType === 'grammar_check') {
            // 语法检查不需要额外配置
        } else if (taskType === 'summary') {
            config.summary_length = 200; // 默认总结长度
        } else if (taskType === 'rewrite') {
            config.style = document.getElementById('rewrite-style').value;
        } else if (taskType === 'complete') {
            config.from_lang = document.getElementById('complete-from-language').value;
            config.to_lang = document.getElementById('complete-to-language').value;
            config.scenario = document.getElementById('complete-scenario').value;
            config.rewrite_style = document.getElementById('complete-style').value;
            config.summary_length = 200;
        }

        isProcessing = true;
        startTime = Date.now();
        
        // 显示处理状态
        showProcessingState();

        try {
            let response;
            
            if (taskType === 'image_translate') {
                // 图片翻译使用FormData
                const formData = new FormData();
                formData.append('type', taskType);
                formData.append('from_lang', config.from_lang || 'auto');
                formData.append('to_lang', config.to_lang || 'zh');
                formData.append('image', config.image_file);
                
                response = await fetch('/api/document/process', {
                    method: 'POST',
                    body: formData
                });
            } else {
                // 其他翻译类型使用JSON
                response = await fetch('/api/document/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: taskType,
                        content: content,
                        from_lang: config.from_lang || 'auto',
                        to_lang: config.to_lang || 'zh',
                        scenario: config.scenario || 'general',
                        domain: config.domain || 'academic',
                        style: config.style || config.rewrite_style || 'formal',
                        summary_length: config.summary_length || 200
                    })
                });
            }

            if (!response.ok) {
                throw new Error('处理请求失败');
            }

            // 处理流式响应
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let resultText = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // 保留不完整的行

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.type === 'message') {
                                // 兼容旧格式
                                resultText = data.full_content;
                                updateResult(resultText);
                            } else if (data.type === 'translation_result') {
                                // 翻译结果
                                resultText = data.content;
                                updateTranslationResult(data);
                            } else if (data.type === 'grammar_result') {
                                // 语法检查结果
                                updateGrammarResult(data.content);
                            } else if (data.type === 'summary_result') {
                                // 总结结果
                                updateSummaryResult(data.content);
                            } else if (data.type === 'rewrite_result') {
                                // 改写结果
                                updateRewriteResult(data.content);
                            } else if (data.type === 'processing_step') {
                                // 完整处理步骤
                                updateProcessingStep(data);
                            } else if (data.type === 'end') {
                                showResultState(resultText);
                            } else if (data.error) {
                                throw new Error(data.error);
                            }
                        } catch (e) {
                            console.error('解析响应数据失败:', e);
                        }
                    }
                }
            }

        } catch (error) {
            showToast(`处理失败: ${error.message}`, 'error');
            showPlaceholderState();
        } finally {
            isProcessing = false;
        }
    }

    // 显示处理状态
    function showProcessingState() {
        document.getElementById('placeholder').classList.add('d-none');
        document.getElementById('result-content').classList.add('d-none');
        document.getElementById('processing').classList.remove('d-none');
        document.getElementById('process-btn').disabled = true;
    }

    // 显示结果状态
    function showResultState(text) {
        document.getElementById('processing').classList.add('d-none');
        document.getElementById('result-content').classList.remove('d-none');
        document.getElementById('process-btn').disabled = false;

        // 更新统计信息
        const processTime = ((Date.now() - startTime) / 1000).toFixed(1);
        document.getElementById('result-chars').textContent = text.length;
        document.getElementById('process-time').textContent = processTime;
    }

    // 显示占位符状态
    function showPlaceholderState() {
        document.getElementById('processing').classList.add('d-none');
        document.getElementById('result-content').classList.add('d-none');
        document.getElementById('placeholder').classList.remove('d-none');
        document.getElementById('process-btn').disabled = false;
    }

    // 更新结果内容
    function updateResult(text) {
        document.getElementById('result-text').textContent = text;
    }

    // 更新翻译结果
    function updateTranslationResult(data) {
        const resultDiv = document.getElementById('result-text');
        resultDiv.innerHTML = `
            <div class="translation-result">
                <div class="mb-3">
                    <h6><i class="fas fa-language me-2"></i>翻译结果</h6>
                    <div class="border rounded p-3 bg-light">${data.content}</div>
                </div>
                <div class="row mt-3 text-center">
                    <div class="col-4">
                        <small class="text-muted">源语言</small><br>
                        <span class="badge bg-info">${data.from_lang}</span>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">目标语言</small><br>
                        <span class="badge bg-success">${data.to_lang}</span>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">字符数</small><br>
                        <span class="fw-bold">${data.content.length}</span>
                    </div>
                </div>
            </div>
        `;
    }

    // 更新语法检查结果
    function updateGrammarResult(result) {
        const resultDiv = document.getElementById('result-text');
        if (result.success) {
            let suggestionsHtml = '';
            if (result.suggestions && result.suggestions.length > 0) {
                suggestionsHtml = result.suggestions.map(s => `<li>${s}</li>`).join('');
                suggestionsHtml = `<ul class="mt-2">${suggestionsHtml}</ul>`;
            } else {
                suggestionsHtml = '<p class="text-success mt-2">未发现语法问题 ✓</p>';
            }

            resultDiv.innerHTML = `
                <div class="grammar-result">
                    <h6><i class="fas fa-spell-check me-2"></i>语法检查结果</h6>
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <span class="me-2">语法评分:</span>
                            <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                <div class="progress-bar bg-${result.grammar_score >= 80 ? 'success' : result.grammar_score >= 60 ? 'warning' : 'danger'}" 
                                     style="width: ${result.grammar_score}%">${result.grammar_score}分</div>
                            </div>
                        </div>
                        <div>
                            <strong>改进建议:</strong>
                            ${suggestionsHtml}
                        </div>
                    </div>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">语法检查失败: ${result.error}</div>`;
        }
    }

    // 更新总结结果
    function updateSummaryResult(result) {
        const resultDiv = document.getElementById('result-text');
        if (result.success) {
            resultDiv.innerHTML = `
                <div class="summary-result">
                    <h6><i class="fas fa-compress-alt me-2"></i>总结结果</h6>
                    <div class="border rounded p-3 bg-light mb-3">${result.summary}</div>
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">原文长度</small><br>
                            <span class="fw-bold">${result.original_length}</span>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">总结长度</small><br>
                            <span class="fw-bold">${result.summary_length}</span>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">压缩比</small><br>
                            <span class="fw-bold">${(result.compression_ratio * 100).toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">总结失败: ${result.error}</div>`;
        }
    }

    // 更新改写结果
    function updateRewriteResult(result) {
        const resultDiv = document.getElementById('result-text');
        if (result.success) {
            let improvementsHtml = '';
            if (result.improvements && result.improvements.length > 0) {
                improvementsHtml = result.improvements.map(i => `<li>${i}</li>`).join('');
                improvementsHtml = `<ul class="mt-2">${improvementsHtml}</ul>`;
            } else {
                improvementsHtml = '<p class="text-muted mt-2">未发现需要改进的地方</p>';
            }

            resultDiv.innerHTML = `
                <div class="rewrite-result">
                    <h6><i class="fas fa-edit me-2"></i>改写结果</h6>
                    <div class="mb-3">
                        <div class="mb-2">
                            <small class="text-muted">原文:</small>
                            <div class="border rounded p-2 bg-light">${result.original_text}</div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">改写:</small>
                            <div class="border rounded p-2 bg-success-subtle">${result.rewritten_text}</div>
                        </div>
                        <div>
                            <strong>改进内容 (${result.improvements.length}处):</strong>
                            ${improvementsHtml}
                        </div>
                    </div>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">改写失败: ${result.error}</div>`;
        }
    }

    // 更新完整处理步骤
    function updateProcessingStep(data) {
        const resultDiv = document.getElementById('result-text');
        const stepName = data.step_name_cn;
        const success = data.success;
        const content = data.content;

        // 如果是第一步，初始化结果容器
        if (data.step === 'translation') {
            resultDiv.innerHTML = `
                <div class="complete-processing">
                    <h6><i class="fas fa-magic me-2"></i>完整处理结果</h6>
                    <div id="processing-steps"></div>
                </div>
            `;
        }

        const stepsContainer = document.getElementById('processing-steps');
        const stepDiv = document.createElement('div');
        stepDiv.className = 'processing-step mb-3';
        
        if (success) {
            stepDiv.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <strong>${stepName}</strong>
                </div>
                <div class="ps-4">
                    ${getStepResultHtml(data.step, content)}
                </div>
            `;
        } else {
            stepDiv.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-times-circle text-danger me-2"></i>
                    <strong>${stepName}</strong>
                </div>
                <div class="ps-4 text-danger">
                    错误: ${content.error}
                </div>
            `;
        }

        stepsContainer.appendChild(stepDiv);
    }

    // 获取步骤结果HTML
    function getStepResultHtml(step, content) {
        switch (step) {
            case 'translation':
                return `<div class="border rounded p-2 bg-light">${content.translated_text}</div>`;
            case 'grammar_check':
                return `<div>语法评分: ${content.grammar_score}分, 建议: ${content.suggestions.length}条</div>`;
            case 'summary':
                return `<div class="border rounded p-2 bg-info-subtle">${content.summary}</div>`;
            case 'rewrite':
                return `<div class="border rounded p-2 bg-success-subtle">${content.rewritten_text}</div>`;
            default:
                return `<div>${JSON.stringify(content, null, 2)}</div>`;
        }
    }

    // 复制结果
    async function copyResult() {
        const resultText = document.getElementById('result-text').textContent;
        if (!resultText) {
            showToast('没有可复制的内容', 'warning');
            return;
        }

        try {
            await navigator.clipboard.writeText(resultText);
            showToast('结果已复制到剪贴板', 'success');
        } catch (err) {
            showToast('复制失败', 'error');
        }
    }

    // 清空输入
    function clearInput() {
        if (confirm('确定要清空输入内容吗？')) {
            document.getElementById('input-text').value = '';
            updateCharCount();
            showPlaceholderState();
        }
    }
</script>

<style>
    .border-dashed {
        border-style: dashed !important;
    }
    
    .border-2 {
        border-width: 2px !important;
    }
    
    #output-area {
        min-height: 500px;
    }
    
    .nav-tabs .nav-link.active {
        background-color: #007bff;
        color: white !important;
        border-color: #007bff;
    }
    
    .progress {
        height: 6px;
    }
    
    .border-end {
        border-right: 1px solid #dee2e6;
    }
    
    @media (max-width: 768px) {
        .border-end {
            border-right: none;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %} 