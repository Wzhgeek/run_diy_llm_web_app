# 文件上传功能重构说明

## 概述

根据您提供的重构需求，我已经对文件上传功能进行了完善，确保按照正确的流程处理文件上传和聊天请求。

## 实现的功能

### 1. 文件上传流程

1. **用户选择文件** - 通过前端文件选择器选择文件
2. **文件验证** - 检查文件类型和大小
3. **上传到服务器** - 调用 `/api/files/upload` 接口获取文件ID
4. **获取文件ID** - 服务器返回包含 `id`、`name`、`size` 等信息的响应
5. **发送聊天请求** - 将文件ID和用户消息一起发送到聊天API

### 2. 请求格式

#### 文件上传响应格式
```json
{
  "id": "72fa9618-8f89-4a37-9b33-7e1178a24a67",
  "name": "example.png", 
  "size": 1024,
  "extension": "png",
  "mime_type": "image/png",
  "created_by": 123,
  "created_at": 1577836800
}
```

#### 图片文件聊天格式
```json
{
  "query": "请分析这张图片",
  "conversation_id": "会话ID（可选）",
  "inputs": {
    "input_image": {
      "type": "image",
      "transfer_method": "local_file",
      "upload_file_id": "文件上传后返回的ID"
    }
  }
}
```

#### 其他文件聊天格式
```json
{
  "query": "请分析这个文档",
  "conversation_id": "会话ID（可选）",
  "inputs": {
    "input_file": {
      "type": "document|audio|video|custom",
      "transfer_method": "local_file",
      "upload_file_id": "文件上传后返回的ID"
    }
  }
}
```

### 3. 支持的文件类型

- **图片**: PNG, JPG, JPEG, GIF, WebP, SVG
- **文档**: PDF, DOC, DOCX, TXT, MD, HTML, CSV, XML
- **音频**: MP3, M4A, WAV, WebM, AMR
- **视频**: MP4, MOV, MPEG, MPGA
- **其他**: 自定义文件类型

### 4. 主要修改内容

#### 前端修改 (static/js/chat.js)

1. **sendMessage函数优化**:
   - 按照新格式构建请求数据
   - 根据文件类型正确设置 inputs 字段
   - 在用户消息中显示文件信息

2. **文件上传体验改进**:
   - 增加上传进度提示
   - 更详细的错误信息显示
   - 更丰富的文件类型图标

3. **文件预览优化**:
   - 不同文件类型显示不同颜色的图标
   - 显示文件大小信息

#### 后端修改 (app.py)

1. **api_chat路由增强**:
   - 支持处理 inputs 中的文件信息
   - 兼容 input_image 和 input_file 两种格式
   - 正确传递文件参数给 Dify API

2. **DifyAPIClient保持兼容**:
   - chat_message 方法无需修改
   - 继续支持 files 参数传递

### 5. 使用方法

1. **打开聊天页面**
2. **点击附件按钮**（📎图标）
3. **选择要上传的文件**
4. **等待文件上传完成**
5. **输入相关问题**（可选）
6. **点击发送按钮**

文件将自动上传并与您的消息一起发送给AI助手进行处理。

### 6. 技术特点

- **两阶段处理**: 先上传文件获取ID，再发送聊天请求
- **类型识别**: 自动识别文件类型并设置正确的type字段
- **用户友好**: 清晰的文件预览和进度提示
- **错误处理**: 完善的错误提示和处理机制
- **响应式设计**: 适配不同屏幕尺寸

### 7. 注意事项

- 文件大小限制为50MB
- 支持的文件类型有限制，请参考上述列表
- 上传的文件会临时存储在服务器，处理完成后自动删除
- 确保网络连接稳定以保证文件上传成功

## 测试建议

1. 测试不同类型的文件上传
2. 测试文件大小限制
3. 测试网络中断时的错误处理
4. 测试文件上传后的聊天功能
5. 测试移动设备上的文件选择和上传 